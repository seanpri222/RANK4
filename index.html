<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Rank 4</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;500;600;700;800;900&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════ RESET + ROOT */
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --ink:#0C0C0C;--paper:#F6F4EF;--white:#FFFFFF;--muted:#9B9690;--edge:#E3E0D8;--lift:#EDEAE3;
  --c0:#E8391E;--c1:#F59E0B;--c2:#0EA572;--c3:#2F54EB;
  --ok:#059669;--ok-tint:#DCFCE7;--fail:#DC2626;--warn:#B45309;
  --p3-a:#7C3AED;--p3-b:#DB2777;--p3-c:#0284C7;
  --btl:#D97706;--bingo:#0F766E;
}
body{background:var(--paper);color:var(--ink);font-family:'Outfit',sans-serif;min-height:100vh;overflow-x:hidden}

/* ═══════════════════════════════════════════════ HEADER */
.site-header{position:sticky;top:0;z-index:300;background:var(--ink);height:58px;display:flex;align-items:center;justify-content:space-between;padding:0 22px}
.site-logo{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:5px;color:white;cursor:pointer}
.site-logo span:nth-child(1){color:var(--c0)}.site-logo span:nth-child(2){color:var(--c1)}.site-logo span:nth-child(3){color:var(--c2)}.site-logo span:nth-child(4){color:var(--c3)}
.header-nav{display:flex;align-items:center;gap:6px}
.nav-btn{font-family:'Outfit',sans-serif;font-size:0.68rem;font-weight:700;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:100px;padding:5px 13px;color:rgba(255,255,255,0.65);cursor:pointer;transition:all 0.15s;white-space:nowrap}
.nav-btn:hover,.nav-btn.active{background:rgba(255,255,255,0.2);color:white;border-color:rgba(255,255,255,0.3)}
.nav-btn.admin-btn{color:rgba(255,255,255,0.3);border-color:rgba(255,255,255,0.08)}
.nav-btn.admin-btn:hover{color:rgba(255,255,255,0.6);background:rgba(255,255,255,0.06)}

/* ═══════════════════════════════════════════════ PAGE SYSTEM */
.page{display:none}.page.active{display:block}

/* ═══════════════════════════════════════════════ HOME PAGE */
.home-hero{background:var(--ink);padding:48px 22px 54px;position:relative;overflow:hidden}
.home-hero::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 80% at 10% 60%,rgba(232,57,30,0.18) 0%,transparent 60%),
    radial-gradient(ellipse 55% 70% at 90% 20%,rgba(47,84,235,0.18) 0%,transparent 60%),
    radial-gradient(ellipse 50% 60% at 55% 90%,rgba(14,165,114,0.14) 0%,transparent 55%)}
.home-hero::after{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:radial-gradient(circle,rgba(255,255,255,0.05) 1px,transparent 1px);background-size:20px 20px}
.home-hero-inner{position:relative;z-index:1;max-width:860px;margin:0 auto;text-align:center}
.home-eyebrow{font-size:0.6rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:14px}
.home-title{font-family:'Bebas Neue',sans-serif;font-size:clamp(3rem,10vw,6rem);letter-spacing:4px;color:white;line-height:1;margin-bottom:10px}
.home-sub{font-size:0.9rem;font-weight:500;color:rgba(255,255,255,0.4);max-width:480px;margin:0 auto 36px;line-height:1.6}
.home-game-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;max-width:860px;margin:0 auto}
.home-game-card{border-radius:18px;padding:22px 14px 20px;text-align:center;border:1.5px solid rgba(255,255,255,0.1);cursor:pointer;transition:transform 0.2s ease,border-color 0.2s,box-shadow 0.2s;position:relative;overflow:hidden}
.home-game-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:18px 18px 0 0}
.home-game-card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(0,0,0,0.4)}
.hgc-rank4{background:rgba(232,57,30,0.12);border-color:rgba(232,57,30,0.25)}.hgc-rank4::before{background:linear-gradient(90deg,var(--c0),var(--c1),var(--c2),var(--c3))}
.hgc-p3{background:rgba(124,58,237,0.12);border-color:rgba(124,58,237,0.25)}.hgc-p3::before{background:var(--p3-a)}
.hgc-btl{background:rgba(217,119,6,0.12);border-color:rgba(217,119,6,0.25)}.hgc-btl::before{background:var(--btl)}
.hgc-bingo{background:rgba(15,118,110,0.12);border-color:rgba(15,118,110,0.25)}.hgc-bingo::before{background:var(--bingo)}
.hgc-emoji{font-size:2.4rem;display:block;margin-bottom:12px;line-height:1;filter:drop-shadow(0 2px 8px rgba(0,0,0,0.5))}
.hgc-name{display:block;font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:2px;color:white;margin-bottom:4px}
.hgc-tag{display:inline-block;font-size:0.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border-radius:4px;background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.55)}
.hgc-rank4 .hgc-tag{background:rgba(232,57,30,0.2);color:rgba(255,100,60,0.9)}

.home-section{max-width:860px;margin:0 auto;padding:36px 20px 80px}
.home-section-label{font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:16px;display:flex;align-items:center;gap:10px}
.home-section-label::after{content:'';flex:1;height:1px;background:var(--edge)}

/* ═══════════════════════════════════════════════ SHARED GAME CHROME */
.game-wrap{max-width:860px;margin:0 auto;padding:20px 16px 80px}
.game-back-bar{display:flex;align-items:center;gap:10px;margin-bottom:18px;padding:0 0 14px;border-bottom:1px solid var(--edge)}
.back-btn{font-family:'Outfit',sans-serif;font-size:0.72rem;font-weight:700;background:none;border:1.5px solid var(--edge);border-radius:100px;padding:6px 14px;color:var(--muted);cursor:pointer;transition:all 0.15s}
.back-btn:hover{border-color:var(--ink);color:var(--ink)}
.game-title-bar{flex:1;display:flex;align-items:center;gap:10px}
.game-title-label{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:3px}

/* ═══════════════════════════════════════════════ ARCHIVE */
.archive-grid{display:flex;flex-direction:column;gap:10px;margin-top:20px}
.archive-item{background:var(--white);border:1.5px solid var(--edge);border-radius:14px;padding:14px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.15s}
.archive-item:hover{border-color:var(--ink);box-shadow:0 4px 14px rgba(0,0,0,0.07);transform:translateX(3px)}
.archive-num{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:2px;color:var(--muted);min-width:50px}
.archive-info{flex:1}
.archive-date{font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px}
.archive-items-preview{font-size:0.78rem;font-weight:600;color:var(--ink)}
.archive-badge{font-size:0.58rem;font-weight:800;letter-spacing:1px;padding:3px 9px;border-radius:6px;background:var(--ink);color:white;text-transform:uppercase}
.archive-badge.today{background:var(--c0);color:white}

/* ═══════════════════════════════════════════════ HOW TO PLAY PAGE */
.htp-wrap{max-width:680px;margin:0 auto;padding:16px 0 80px}
.htp-section{background:var(--white);border:1.5px solid var(--edge);border-radius:20px;padding:28px 26px;margin-bottom:16px;overflow:hidden;position:relative}
.htp-section::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.htp-section-rank4::before{background:linear-gradient(90deg,var(--c0),var(--c1),var(--c2),var(--c3))}
.htp-section-p3::before{background:var(--p3-a)}
.htp-section-btl::before{background:var(--btl)}
.htp-section-bingo::before{background:var(--bingo)}
.htp-game-name{font-family:'Bebas Neue',sans-serif;font-size:1.8rem;letter-spacing:3px;margin-bottom:4px}
.htp-game-tag{font-size:0.6rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:block}
.htp-steps{display:flex;flex-direction:column;gap:10px}
.htp-step{display:flex;align-items:flex-start;gap:12px}
.htp-step-num{width:26px;height:26px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:800;flex-shrink:0;margin-top:1px;color:white}
.htp-step-num-rank4{background:var(--c0)}.htp-step-num-p3{background:var(--p3-a)}.htp-step-num-btl{background:var(--btl)}.htp-step-num-bingo{background:var(--bingo)}
.htp-step-text{font-size:0.8rem;font-weight:500;color:#444;line-height:1.6}
.htp-step-text strong{color:var(--ink);font-weight:800}
.htp-play-btn{display:inline-block;margin-top:18px;font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:800;padding:10px 24px;border:none;border-radius:100px;cursor:pointer;color:white;transition:all 0.14s}
.htp-play-btn:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(0,0,0,0.25)}

/* ═══════════════════════════════════════════════ ADMIN PANEL */
.admin-login{max-width:400px;margin:60px auto;background:var(--white);border:2px solid var(--ink);border-radius:20px;padding:36px;box-shadow:6px 6px 0 var(--ink);text-align:center}
.admin-login-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:6px}
.admin-login-sub{font-size:0.75rem;color:var(--muted);margin-bottom:24px}
.admin-pw-field{width:100%;padding:12px 16px;border:2px solid var(--edge);border-radius:10px;font-family:'Outfit',sans-serif;font-size:0.9rem;font-weight:600;outline:none;transition:border-color 0.15s;margin-bottom:12px}
.admin-pw-field:focus{border-color:var(--ink)}
.admin-login-btn{width:100%;padding:12px;background:var(--ink);color:white;border:none;border-radius:100px;font-family:'Outfit',sans-serif;font-size:0.85rem;font-weight:800;cursor:pointer;transition:background 0.14s}
.admin-login-btn:hover{background:#252525}
.admin-err{font-size:0.72rem;color:var(--fail);margin-top:8px;min-height:18px}

/* Admin panel body */
.admin-panel{max-width:860px;margin:0 auto;padding:24px 16px 80px}
.admin-section-title{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:3px;margin-bottom:4px}
.admin-section-sub{font-size:0.75rem;color:var(--muted);margin-bottom:22px}
.admin-tabs{display:flex;gap:8px;margin-bottom:22px;flex-wrap:wrap}
.admin-tab{font-family:'Outfit',sans-serif;font-size:0.72rem;font-weight:700;padding:8px 18px;border:2px solid var(--edge);border-radius:100px;background:var(--white);color:var(--muted);cursor:pointer;transition:all 0.14s}
.admin-tab.active{background:var(--ink);color:white;border-color:var(--ink)}
.admin-tab-content{display:none}.admin-tab-content.active{display:block}
.admin-card{background:var(--white);border:2px solid var(--edge);border-radius:16px;padding:22px;margin-bottom:16px}
.admin-card-title{font-size:0.72rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.form-row.single{grid-template-columns:1fr}
.form-row.four{grid-template-columns:repeat(4,1fr)}
label.form-label{font-size:0.62rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:4px}
input.form-input,textarea.form-input{width:100%;padding:9px 12px;border:1.5px solid var(--edge);border-radius:8px;font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:600;outline:none;transition:border-color 0.15s;background:var(--paper)}
input.form-input:focus,textarea.form-input:focus{border-color:var(--ink);background:white}
textarea.form-input{resize:vertical;min-height:60px}
.form-hint{font-size:0.6rem;color:var(--muted);margin-top:3px}
.btn-admin-save{background:var(--ok);color:white;border:none;border-radius:100px;padding:10px 26px;font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:800;cursor:pointer;transition:all 0.14s;display:inline-flex;align-items:center;gap:7px}
.btn-admin-save:hover{background:#047857;transform:translateY(-1px);box-shadow:0 5px 16px rgba(5,150,105,0.35)}
.btn-admin-del{background:none;color:var(--fail);border:1.5px solid #FCA5A5;border-radius:100px;padding:6px 14px;font-family:'Outfit',sans-serif;font-size:0.7rem;font-weight:700;cursor:pointer;transition:all 0.14s}
.btn-admin-del:hover{background:#FEE2E2}
.admin-list{display:flex;flex-direction:column;gap:8px;margin-top:16px}
.admin-list-item{background:var(--paper);border:1.5px solid var(--edge);border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:12px}
.admin-list-item-info{flex:1}
.admin-list-date{font-size:0.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.admin-list-name{font-size:0.8rem;font-weight:700;color:var(--ink)}
.admin-save-msg{font-size:0.72rem;font-weight:700;color:var(--ok);margin-left:14px;opacity:0;transition:opacity 0.3s}
.admin-save-msg.show{opacity:1}
.cat-order-fields{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.cat-order-row{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:center}
.order-num{font-size:0.65rem;font-weight:800;color:var(--muted);width:22px;text-align:right}
.cat-color-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.cat-color-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}

/* ═══════════════════════════════════════════════ RANK 4 GAME */
.rank4-hero{background:var(--ink);padding:28px 22px 34px;position:relative;overflow:hidden}
.rank4-hero::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 80% at 10% 60%,rgba(232,57,30,0.18) 0%,transparent 60%),
    radial-gradient(ellipse 55% 70% at 90% 20%,rgba(47,84,235,0.18) 0%,transparent 60%),
    radial-gradient(ellipse 50% 60% at 55% 90%,rgba(14,165,114,0.14) 0%,transparent 55%)}
.rank4-hero::after{content:'';position:absolute;inset:0;pointer-events:none;
  background-image:radial-gradient(circle,rgba(255,255,255,0.05) 1px,transparent 1px);background-size:20px 20px}
.rank4-hero-inner{position:relative;z-index:1;max-width:840px;margin:0 auto}
.r4-eyebrow{display:inline-flex;align-items:center;gap:7px;font-size:0.58rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:6px}
.r4-eyebrow::before{content:'';width:18px;height:1.5px;background:rgba(255,255,255,0.22);flex-shrink:0}
.r4-heading{font-family:'Bebas Neue',sans-serif;font-size:clamp(2rem,6vw,3.4rem);letter-spacing:2px;color:white;line-height:1;margin-bottom:5px}
.r4-sub{font-size:0.76rem;font-weight:500;color:rgba(255,255,255,0.35);margin-bottom:22px}
.r4-hero-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.r4-hero-card{border-radius:14px;padding:16px 10px 14px;text-align:center;border:1.5px solid rgba(255,255,255,0.1);position:relative;overflow:hidden;transition:transform 0.2s}
.r4-hero-card:hover{transform:translateY(-3px)}
.r4-hero-card:nth-child(1){background:rgba(232,57,30,0.14);border-color:rgba(232,57,30,0.28)}
.r4-hero-card:nth-child(2){background:rgba(245,158,11,0.13);border-color:rgba(245,158,11,0.25)}
.r4-hero-card:nth-child(3){background:rgba(14,165,114,0.13);border-color:rgba(14,165,114,0.25)}
.r4-hero-card:nth-child(4){background:rgba(47,84,235,0.13);border-color:rgba(47,84,235,0.25)}
.r4-hero-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:14px 14px 0 0}
.r4-hero-card:nth-child(1)::before{background:var(--c0)}.r4-hero-card:nth-child(2)::before{background:var(--c1)}
.r4-hero-card:nth-child(3)::before{background:var(--c2)}.r4-hero-card:nth-child(4)::before{background:var(--c3)}
.r4-card-emoji{font-size:1.9rem;display:block;margin-bottom:8px;filter:drop-shadow(0 2px 6px rgba(0,0,0,0.4))}
.r4-card-name{display:block;font-size:0.76rem;font-weight:700;color:rgba(255,255,255,0.9);line-height:1.2}

/* Progress bar */
.r4-progress{background:var(--white);border-bottom:1.5px solid var(--edge);padding:10px 22px}
.r4-progress-inner{max-width:840px;margin:0 auto;display:flex;align-items:center;gap:12px}
.progress-label{font-size:0.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);white-space:nowrap}
.progress-pips{display:flex;gap:5px;flex:1}
.pip{flex:1;height:5px;border-radius:3px;background:var(--edge);transition:background 0.4s ease}
.pip.lit-0{background:var(--c0)}.pip.lit-1{background:var(--c1)}.pip.lit-2{background:var(--c2)}.pip.lit-3{background:var(--c3)}
.progress-checks{display:flex;align-items:center;gap:7px;font-size:0.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.check-pips{display:flex;gap:4px}
.check-pip{width:10px;height:10px;border-radius:50%;background:var(--edge);transition:background 0.3s}
.check-pip.used{background:var(--fail)}.check-pip.remaining{background:var(--ink)}
.progress-pair{display:flex;align-items:center;gap:6px;font-size:0.58rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted)}
.pair-pip{width:22px;height:5px;border-radius:3px;background:var(--edge);transition:background 0.4s ease}
.pair-pip.lit{background:var(--ok)}

/* Pair finder box */
.pair-box{background:var(--white);border-radius:16px;border:2px solid var(--ink);overflow:hidden;margin-bottom:18px;box-shadow:3px 3px 0 var(--ink)}
.pair-head{background:var(--ink);padding:12px 18px;display:flex;align-items:center;gap:10px}
.pair-head-icon{font-size:1rem}
.pair-head-text{flex:1}
.pair-head-title{font-size:0.85rem;font-weight:800;color:white;line-height:1;margin-bottom:2px}
.pair-head-hint{font-size:0.65rem;font-weight:500;color:rgba(255,255,255,0.42)}
.pair-body{padding:14px 18px 18px}
.pair-pills{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
.pair-pill{border:2px solid;border-radius:100px;padding:7px 18px;font-size:0.73rem;font-weight:700;cursor:pointer;transition:all 0.14s ease;background:var(--white);user-select:none}
.pair-pill:hover:not([disabled]){transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.12)}
.pair-pill[disabled]{cursor:default}
.pair-pill.pp0{border-color:var(--c0);color:var(--c0)}.pair-pill.pp1{border-color:var(--c1);color:var(--c1)}
.pair-pill.pp2{border-color:var(--c2);color:var(--c2)}.pair-pill.pp3{border-color:var(--c3);color:var(--c3)}
.pair-pill.pp0.sel{background:var(--c0);color:white;box-shadow:0 4px 14px rgba(232,57,30,0.4)}
.pair-pill.pp1.sel{background:var(--c1);color:white;box-shadow:0 4px 14px rgba(245,158,11,0.4)}
.pair-pill.pp2.sel{background:var(--c2);color:white;box-shadow:0 4px 14px rgba(14,165,114,0.4)}
.pair-pill.pp3.sel{background:var(--c3);color:white;box-shadow:0 4px 14px rgba(47,84,235,0.4)}
.pair-pill.linked-done{opacity:0.55;cursor:default;color:white!important}
.pair-pill.pp0.linked-done{background:var(--c0)}.pair-pill.pp1.linked-done{background:var(--c1)}
.pair-pill.pp2.linked-done{background:var(--c2)}.pair-pill.pp3.linked-done{background:var(--c3)}
.pair-foot{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.btn-link{font-family:'Outfit',sans-serif;font-size:0.76rem;font-weight:800;padding:9px 22px;border:2px solid var(--ink);border-radius:100px;background:var(--ink);color:white;cursor:pointer;transition:all 0.14s}
.btn-link:hover:not([disabled]){background:#252525;transform:translateY(-1px);box-shadow:0 5px 16px rgba(0,0,0,0.25)}
.btn-link[disabled]{opacity:0.25;cursor:not-allowed;transform:none!important;box-shadow:none!important}
.pair-msg{font-size:0.75rem;font-weight:600;color:var(--muted);flex:1;min-height:18px}
.pair-msg.ok{color:var(--ok)}.pair-msg.err{color:var(--fail)}
.pair-wrong-reveal{display:none;margin-top:14px;background:#FEF9F0;border:1.5px solid #FBBF24;border-radius:12px;padding:14px 16px}
.pair-wrong-reveal.show{display:block}
.pair-wrong-title{font-size:0.72rem;font-weight:800;color:var(--warn);letter-spacing:0.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px}
.pair-wrong-rows{display:flex;flex-direction:column;gap:8px}
.pair-wrong-row{display:flex;align-items:flex-start;gap:10px}
.pair-wrong-label{font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;min-width:110px;padding-top:6px}
.pair-wrong-tiles{display:flex;gap:5px;align-items:center;flex-wrap:wrap}
.pwt{font-size:0.7rem;font-weight:600;padding:5px 10px;border-radius:8px;border:1.5px solid var(--edge);background:var(--white)}
.pwt.wrong{background:#FEE2E2;border-color:#FCA5A5;color:var(--fail);font-weight:700}
.pwr-arrow{color:#CBD5E1;font-size:0.75rem}
.swap-hint{font-size:0.65rem;font-weight:600;color:#92400E;margin-top:10px;padding-top:10px;border-top:1px solid #FDE68A;display:flex;align-items:center;gap:5px}

/* Category cards */
.cats-list{display:flex;flex-direction:column;gap:12px}
.cat-block{background:var(--white);border-radius:16px;border:1.5px solid var(--edge);overflow:hidden;animation:riseIn 0.45s cubic-bezier(0.22,1,0.36,1) both;transition:box-shadow 0.2s,border-color 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.04)}
.cat-block:hover{box-shadow:0 6px 20px rgba(0,0,0,0.07)}
.cat-block:nth-child(1){animation-delay:0.06s}.cat-block:nth-child(2){animation-delay:0.12s}
.cat-block:nth-child(3){animation-delay:0.18s}.cat-block:nth-child(4){animation-delay:0.24s}
.cat-block.correct{border-color:#86EFAC;box-shadow:0 4px 20px rgba(14,165,114,0.12);animation:correctPulse 0.7s ease both 0.05s}
.cat-block.wrong-flash{animation:shake 0.35s ease!important}
.cat-topbar{height:4px}
.cat-block.b0 .cat-topbar{background:var(--c0)}.cat-block.b1 .cat-topbar{background:var(--c1)}
.cat-block.b2 .cat-topbar{background:var(--c2)}.cat-block.b3 .cat-topbar{background:var(--c3)}
.cat-block.correct .cat-topbar{background:var(--ok)}
.cat-header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;gap:12px}
.cat-block.b0:not(.correct) .cat-header{background:#FFF3F1}.cat-block.b1:not(.correct) .cat-header{background:#FFFBEB}
.cat-block.b2:not(.correct) .cat-header{background:#F0FDF8}.cat-block.b3:not(.correct) .cat-header{background:#EEF2FF}
.cat-block.correct .cat-header{background:#F0FDF4}
.cat-header-left{display:flex;align-items:center;gap:10px;flex:1}
.cat-swatch{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.cat-block.b0 .cat-swatch{background:var(--c0)}.cat-block.b1 .cat-swatch{background:var(--c1)}
.cat-block.b2 .cat-swatch{background:var(--c2)}.cat-block.b3 .cat-swatch{background:var(--c3)}
.cat-block.correct .cat-swatch{background:var(--ok)}
.cat-name{font-family:'Bebas Neue',sans-serif;font-size:1.05rem;letter-spacing:2px;line-height:1}
.cat-block.b0 .cat-name{color:var(--c0)}.cat-block.b1 .cat-name{color:var(--c1)}
.cat-block.b2 .cat-name{color:var(--c2)}.cat-block.b3 .cat-name{color:var(--c3)}
.cat-block.correct .cat-name{color:var(--ok)}
.cat-desc{font-size:0.62rem;font-weight:500;color:var(--muted);margin-top:1px}
.cat-header-right{display:flex;align-items:center;gap:9px;flex-shrink:0}
.star-slot{font-size:1.15rem;line-height:1;filter:grayscale(1);opacity:0.15;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1)}
.star-slot.lit{filter:none;opacity:1;animation:starPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both}
.btn-check{font-family:'Outfit',sans-serif;font-size:0.68rem;font-weight:700;padding:7px 14px;border-radius:100px;border:2px solid;background:transparent;cursor:pointer;transition:all 0.14s;white-space:nowrap}
.cat-block.b0 .btn-check{border-color:var(--c0);color:var(--c0)}.cat-block.b1 .btn-check{border-color:var(--c1);color:var(--c1)}
.cat-block.b2 .btn-check{border-color:var(--c2);color:var(--c2)}.cat-block.b3 .btn-check{border-color:var(--c3);color:var(--c3)}
.cat-block.b0 .btn-check:hover:not([disabled]){background:var(--c0);color:white}
.cat-block.b1 .btn-check:hover:not([disabled]){background:var(--c1);color:white}
.cat-block.b2 .btn-check:hover:not([disabled]){background:var(--c2);color:white}
.cat-block.b3 .btn-check:hover:not([disabled]){background:var(--c3);color:white}
.btn-check[disabled]{opacity:0.3;cursor:not-allowed}
.btn-check.is-correct{color:var(--ok)!important;border-color:#6EE7B7!important;background:var(--ok-tint)!important}
.btn-check.is-wrong{color:var(--fail)!important;border-color:#FCA5A5!important}
.btn-check.no-checks{color:var(--muted)!important;border-color:var(--edge)!important;background:var(--lift)!important;opacity:0.7}

/* Rank row */
.rank-row{display:flex;align-items:stretch;padding:14px 12px 10px;gap:0;user-select:none;-webkit-user-select:none}
.rank-entry{display:flex;flex-direction:column;align-items:center;gap:5px;flex:1;min-width:0}
.rank-num{font-size:0.56rem;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase}
.rank-tile{width:100%;height:64px;background:var(--lift);border:1.5px solid var(--edge);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:600;text-align:center;padding:6px 4px;line-height:1.25;cursor:grab;touch-action:none;transition:background 0.12s,border-color 0.12s,box-shadow 0.12s,transform 0.12s;position:relative;background-image:radial-gradient(circle,var(--edge) 1px,transparent 1px);background-size:8px 8px;background-position:calc(100% - 5px) 5px;background-repeat:no-repeat;background-color:var(--lift);will-change:transform;overflow:hidden}
.rank-tile:hover{background-color:var(--edge);border-color:#C5C0B8}
.rank-tile.dragging{opacity:0.2;transform:scale(0.95);box-shadow:none}
.rank-tile.drag-over{border-color:var(--c3);border-style:dashed;background-color:#EEF2FF;box-shadow:0 0 0 3px rgba(47,84,235,0.15);transform:scale(1.03)}
.correct .rank-tile{background-color:var(--ok-tint);background-image:none;border-color:#86EFAC;cursor:default;touch-action:auto}
.rank-tile.locked{background-color:var(--ok-tint)!important;background-image:none!important;border-color:#86EFAC!important;cursor:default!important;touch-action:auto!important;color:var(--ok);font-weight:700;box-shadow:0 0 0 2px rgba(14,165,114,0.2)}
.rank-tile.locked::after{content:'✓';position:absolute;top:4px;right:6px;font-size:0.55rem;color:var(--ok);font-weight:800}
.rank-arrow{color:var(--edge);font-size:0.75rem;flex-shrink:0;align-self:flex-start;margin-top:34px;padding:0 1px}
.item-fact{font-size:0.57rem;font-weight:600;color:transparent;text-align:center;line-height:1.3;width:100%;padding:0 2px;min-height:18px;transition:color 0.3s ease 0.2s}
.item-fact.revealed{color:var(--ok)}
.drag-ghost{position:fixed;pointer-events:none;z-index:9999;background:var(--ink);color:white;border-radius:12px;padding:10px 14px;font-family:'Outfit',sans-serif;font-size:0.78rem;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,0.35);transform:rotate(2deg) scale(1.05);transition:none;white-space:nowrap;max-width:140px;text-align:center;line-height:1.2}
.checks-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--ink);color:white;border-radius:100px;padding:10px 22px;font-size:0.78rem;font-weight:700;z-index:500;opacity:0;pointer-events:none;transition:opacity 0.3s ease;white-space:nowrap}
.checks-toast.show{opacity:1}

/* ═══════════════════════════════════════════════ RANK 4 RESULTS */
.r4-results{display:none;animation:riseIn 0.5s cubic-bezier(0.22,1,0.36,1) both}
.r4-results.show{display:block}
.r4-res-card{background:var(--ink);border-radius:20px;overflow:hidden;margin-bottom:18px;border:2px solid var(--ink);box-shadow:4px 4px 0 var(--ink)}
.r4-res-stripe{height:6px;background:linear-gradient(90deg,var(--c0) 0%,var(--c1) 33%,var(--c2) 66%,var(--c3) 100%)}
.r4-res-stripe.fail{background:linear-gradient(90deg,#7F1D1D,#DC2626,#7F1D1D)}
.r4-res-body{padding:36px 24px 32px;text-align:center;position:relative;overflow:hidden}
.r4-res-body::before{content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse 50% 70% at 12% 40%,rgba(232,57,30,0.2) 0%,transparent 55%),
    radial-gradient(ellipse 50% 70% at 88% 20%,rgba(47,84,235,0.2) 0%,transparent 55%)}
.r4-res-body.fail::before{background:radial-gradient(ellipse 60% 80% at 20% 50%,rgba(220,38,38,0.25) 0%,transparent 60%)}
.r4-res-logo{font-family:'DM Serif Display',serif;font-size:3rem;letter-spacing:2px;position:relative;margin-bottom:4px;color:white;font-style:italic}
.r4-res-logo-r{color:var(--c0)}.r4-res-logo-a{color:var(--c1)}.r4-res-logo-n{color:var(--c2)}.r4-res-logo-k{color:var(--c3)}
.r4-res-date{font-size:0.62rem;font-weight:600;letter-spacing:2.5px;text-transform:uppercase;color:rgba(255,255,255,0.32);margin-bottom:18px;position:relative}
.r4-res-pair-stat{position:relative;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:10px}
.r4-res-pair-found{font-family:'DM Serif Display',serif;font-size:2rem;color:#4ADE80;font-style:italic}
.r4-res-pair-icon{font-size:1.6rem}
.r4-res-pair-label{font-size:0.6rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.3);margin-bottom:4px;position:relative}
.r4-stars-row{display:flex;justify-content:center;gap:6px;margin-bottom:6px;position:relative}
.r4-star{font-size:2.1rem;animation:starPop 0.5s cubic-bezier(0.34,1.56,0.64,1) both;display:inline-block}
.r4-score-sub{font-size:0.65rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.28);margin-bottom:22px;position:relative}
.r4-share-box{background:rgba(255,255,255,0.07);border:1.5px solid rgba(255,255,255,0.12);border-radius:12px;padding:16px 20px;font-family:monospace;font-size:0.8rem;line-height:1.85;white-space:pre;color:rgba(255,255,255,0.82);display:inline-block;text-align:left;margin-bottom:14px;position:relative;max-width:100%}
.r4-share-prompt{font-size:0.75rem;font-weight:600;color:rgba(255,255,255,0.45);margin-bottom:14px;position:relative}
.r4-share-prompt a{color:rgba(255,255,255,0.7);text-decoration:underline}
.btn-copy{display:block;margin:0 auto;background:white;color:var(--ink);border:none;border-radius:100px;padding:11px 30px;font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:800;cursor:pointer;transition:all 0.14s;position:relative}
.btn-copy:hover{background:#EDEDED;transform:translateY(-1px);box-shadow:0 5px 16px rgba(0,0,0,0.25)}
.r4-fail-icon{font-size:3.2rem;margin-bottom:10px;position:relative}
.r4-fail-heading{font-family:'DM Serif Display',serif;font-size:2.5rem;color:white;position:relative;margin-bottom:6px;font-style:italic}
.r4-fail-sub{font-size:0.82rem;font-weight:500;color:rgba(255,255,255,0.45);margin-bottom:24px;position:relative;line-height:1.6}
.r4-answers{background:var(--white);border:1.5px solid var(--edge);border-radius:16px;padding:20px}
.r4-answers-label{font-size:0.58rem;font-weight:700;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:16px}
.r4-answer-rows{display:flex;flex-direction:column;gap:16px}
.r4-answer-row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap}
.r4-answer-cat{font-size:0.66rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;min-width:130px;padding-top:5px;display:flex;align-items:center;gap:7px;flex-shrink:0}
.r4-answer-pills{display:flex;gap:5px;align-items:flex-start;flex-wrap:wrap}
.r4-pill-wrap{display:flex;flex-direction:column;align-items:center;gap:3px}
.r4-item-pill{background:var(--lift);border:1.5px solid var(--edge);border-radius:100px;padding:4px 11px;font-size:0.7rem;font-weight:600;white-space:nowrap}
.r4-item-fact{font-size:0.58rem;font-weight:600;color:var(--ok);text-align:center;line-height:1.2;max-width:90px}
.ans-arrow{font-size:0.7rem;color:var(--edge);padding-top:6px}
.match-flag{font-size:0.5rem;font-weight:800;letter-spacing:1px;padding:2px 7px;border-radius:4px;background:var(--ink);color:white;text-transform:uppercase}

/* ═══════════════════════════════════════════════ PERFECT 3s */
.p3-wrap{max-width:580px;margin:0 auto;padding:16px 0 60px}
.p3-header{background:linear-gradient(135deg,var(--p3-a),var(--p3-b));border-radius:16px;padding:20px 20px 16px;margin-bottom:16px;color:white}
.p3-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:2px}
.p3-sub{font-size:0.72rem;font-weight:500;opacity:0.8;margin-bottom:10px}
.p3-header-bottom{display:flex;align-items:center;justify-content:space-between}
.p3-attempts-label{font-size:0.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;opacity:0.7}
.p3-attempts{display:flex;gap:6px;align-items:center}
.p3-dot{width:13px;height:13px;border-radius:50%;background:rgba(255,255,255,0.28);transition:all 0.3s;border:1.5px solid rgba(255,255,255,0.4)}
.p3-dot.used{background:rgba(255,80,80,0.9);border-color:rgba(255,80,80,0.6)}
.p3-dot.ok{background:rgba(74,222,128,0.9);border-color:rgba(74,222,128,0.6)}
.p3-solved-group{border-radius:12px;padding:14px 16px;margin-bottom:10px;animation:riseIn 0.4s ease both}
.p3-solved-group.sg0{background:rgba(124,58,237,0.1);border:2px solid rgba(124,58,237,0.3)}
.p3-solved-group.sg1{background:rgba(219,39,119,0.1);border:2px solid rgba(219,39,119,0.3)}
.p3-solved-group.sg2{background:rgba(2,132,199,0.1);border:2px solid rgba(2,132,199,0.3)}
/* CHANGED: bigger category name text in solved groups */
.p3-solved-name{font-size:0.88rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px}
.p3-solved-items-row{display:flex;gap:6px;flex-wrap:wrap}
.p3-solved-pill{font-size:0.78rem;font-weight:700;padding:5px 12px;border-radius:8px;background:rgba(255,255,255,0.7)}
.p3-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:16px}
.p3-item{background:var(--white);border:2px solid var(--edge);border-radius:14px;padding:16px 8px;text-align:center;font-size:0.82rem;font-weight:700;cursor:pointer;transition:all 0.16s;user-select:none;min-height:62px;display:flex;align-items:center;justify-content:center;line-height:1.25;box-shadow:0 1px 3px rgba(0,0,0,0.04)}
.p3-item:hover:not(.solved-tile){border-color:var(--p3-a);background:#FAF5FF;transform:translateY(-2px);box-shadow:0 5px 14px rgba(124,58,237,0.13)}
.p3-item.sel{border-color:var(--p3-a);background:#EDE9FE;color:var(--p3-a);transform:translateY(-2px);box-shadow:0 5px 14px rgba(124,58,237,0.2)}
.p3-item.sel1{border-color:var(--p3-b);background:#FDF2F8;color:var(--p3-b);transform:translateY(-2px)}
.p3-item.sel2{border-color:var(--p3-c);background:#EFF6FF;color:var(--p3-c);transform:translateY(-2px)}
.p3-item.solved-tile{cursor:default;transform:none;pointer-events:none}
.p3-item.solved-tile.sg0{background:rgba(124,58,237,0.08);border-color:rgba(124,58,237,0.35);color:var(--p3-a)}
.p3-item.solved-tile.sg1{background:rgba(219,39,119,0.08);border-color:rgba(219,39,119,0.35);color:var(--p3-b)}
.p3-item.solved-tile.sg2{background:rgba(2,132,199,0.08);border-color:rgba(2,132,199,0.35);color:var(--p3-c)}
.p3-item.wrong-flash{animation:shake 0.35s ease;border-color:#FCA5A5!important;background:#FEF2F2!important}
.p3-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn-p3-submit{font-family:'Outfit',sans-serif;font-size:0.8rem;font-weight:800;padding:10px 24px;background:var(--p3-a);color:white;border:none;border-radius:100px;cursor:pointer;transition:all 0.14s}
.btn-p3-submit:hover:not([disabled]){background:#6D28D9;transform:translateY(-1px);box-shadow:0 5px 16px rgba(124,58,237,0.35)}
.btn-p3-submit[disabled]{opacity:0.3;cursor:not-allowed}
.p3-msg{font-size:0.78rem;font-weight:600;color:var(--muted);flex:1;min-height:20px}
.p3-msg.ok{color:var(--ok)}.p3-msg.err{color:var(--fail)}.p3-msg.warn{color:var(--warn)}
.p3-gameover-reveal{margin-top:16px;background:var(--lift);border-radius:14px;padding:16px;border:1.5px solid var(--edge)}
.p3-gameover-label{font-size:0.6rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:10px}
.p3-reveal-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;flex-wrap:wrap}
.p3-reveal-label{font-size:0.65rem;font-weight:800;text-transform:uppercase;min-width:90px}
.p3-reveal-pill{font-size:0.72rem;font-weight:600;padding:4px 10px;border-radius:7px;background:var(--white);border:1.5px solid var(--edge)}

/* ═══════════════════════════════════════════════ BUILD THE LINE */
.btl-wrap{max-width:680px;margin:0 auto;padding:16px 0 60px}
.btl-header{background:linear-gradient(135deg,#78350F,var(--btl));border-radius:16px;padding:20px 22px;margin-bottom:18px;color:white;display:flex;align-items:center;justify-content:space-between;gap:14px}
.btl-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px;margin-bottom:2px}
.btl-cat-label{font-size:0.7rem;font-weight:600;opacity:0.7}
.btl-header-right{text-align:right;flex-shrink:0}
.btl-score-big{font-family:'Bebas Neue',sans-serif;font-size:2.8rem;letter-spacing:2px;line-height:1}
.btl-score-lbl{font-size:0.58rem;font-weight:700;opacity:0.6;letter-spacing:1.5px;text-transform:uppercase}
.btl-item-card{background:var(--white);border-radius:18px;border:2px solid var(--ink);box-shadow:4px 4px 0 var(--ink);padding:18px 20px;margin-bottom:22px;display:flex;align-items:center;gap:16px;animation:riseIn 0.35s ease both}
.btl-item-emoji{font-size:2.8rem;line-height:1;flex-shrink:0;filter:drop-shadow(0 3px 6px rgba(0,0,0,0.15))}
.btl-item-info{flex:1}
.btl-item-eyebrow{font-size:0.58rem;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px}
.btl-item-name{font-family:'Bebas Neue',sans-serif;font-size:1.7rem;letter-spacing:2px;color:var(--ink);line-height:1.1}
.btl-item-progress{display:flex;gap:4px;margin-top:10px}
.btl-prog-dot{width:8px;height:8px;border-radius:50%;background:var(--edge);transition:background 0.3s}
.btl-prog-dot.placed{background:var(--btl)}.btl-prog-dot.current{background:var(--ink);transform:scale(1.3)}
.btl-line-wrap{margin-bottom:20px}
.btl-line-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.btl-line-end-label{font-size:0.6rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted)}
.btl-spine{position:relative;padding:0 4px}
.btl-spine::before{content:'';position:absolute;left:26px;top:0;bottom:0;width:3px;background:linear-gradient(to bottom,var(--btl),rgba(217,119,6,0.2));border-radius:2px;z-index:0}
.btl-insert-zone{display:flex;align-items:center;cursor:pointer;margin:3px 0;min-height:40px;padding-left:0;transition:all 0.15s;border-radius:10px}
.btl-insert-zone:hover .btl-insert-inner{border-color:var(--btl);background:rgba(217,119,6,0.06);transform:translateX(4px)}
.btl-insert-inner{margin-left:42px;flex:1;border:2px dashed var(--edge);border-radius:10px;padding:7px 14px;font-size:0.72rem;font-weight:700;color:var(--muted);transition:all 0.15s;background:var(--white);display:flex;align-items:center;gap:8px}
.btl-insert-inner span.plus{color:var(--edge);font-size:1rem;font-weight:900;transition:color 0.15s}
.btl-insert-zone:hover .btl-insert-inner span.plus{color:var(--btl)}
.btl-placed-node{display:flex;align-items:center;gap:0;padding:3px 0;z-index:1;position:relative}
.btl-node-dot{width:14px;height:14px;border-radius:50%;border:3px solid var(--btl);background:white;flex-shrink:0;margin-left:20px;z-index:2;transition:all 0.3s}
.btl-node-dot.correct{background:var(--ok);border-color:var(--ok)}
.btl-node-dot.wrong{background:var(--fail);border-color:var(--fail)}
.btl-placed-card{flex:1;background:var(--lift);border:2px solid var(--edge);border-radius:12px;padding:9px 14px;display:flex;align-items:center;gap:10px;font-size:0.8rem;font-weight:700;transition:all 0.35s;margin-left:8px}
.btl-placed-card.correct{background:var(--ok-tint);border-color:#86EFAC;color:var(--ok)}
.btl-placed-card.wrong{background:#FEE2E2;border-color:#FCA5A5;color:var(--fail)}
.btl-placed-card.partial{background:#FEF9C3;border-color:#FDE047;color:#713F12}
.btl-placed-emoji-sm{font-size:1.2rem;flex-shrink:0}
.btl-placed-text{flex:1;line-height:1.2}
.btl-placed-value{font-size:0.6rem;font-weight:600;opacity:0.6;margin-left:auto;white-space:nowrap}
.btl-placed-pts{font-size:0.68rem;font-weight:800;margin-left:6px;white-space:nowrap}
.btl-result-card{background:var(--ink);border-radius:20px;padding:30px 24px;text-align:center;color:white;margin-bottom:18px;border:2px solid var(--ink);box-shadow:4px 4px 0 var(--ink)}
.btl-result-heading{font-family:'DM Serif Display',serif;font-size:1.7rem;font-style:italic;color:rgba(255,255,255,0.9);margin-bottom:16px;line-height:1.4}
.btl-result-pts{font-family:'Bebas Neue',sans-serif;font-size:4.5rem;letter-spacing:3px;color:var(--btl);line-height:1;margin-bottom:4px}
.btl-result-pts-lbl{font-size:0.65rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:14px}
.btl-result-bar{height:8px;border-radius:4px;background:rgba(255,255,255,0.1);margin:14px 0 6px;overflow:hidden}
.btl-result-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--btl),#FDE68A);width:0;transition:width 0.9s ease 0.4s}
.btl-result-pct{font-size:0.72rem;font-weight:600;color:rgba(255,255,255,0.35)}

/* ═══════════════════════════════════════════════ TRIVIA BINGO — redesigned */
.bingo-wrap{max-width:700px;margin:0 auto;padding:16px 0 60px}

/* New Bingo Header */
.bingo-masthead{background:var(--ink);border-radius:16px;padding:22px 24px 18px;margin-bottom:14px;position:relative;overflow:hidden}
.bingo-masthead::before{content:'';position:absolute;inset:0;pointer-events:none;background:radial-gradient(ellipse 60% 80% at 5% 70%,rgba(15,118,110,0.5) 0%,transparent 55%),radial-gradient(ellipse 50% 60% at 90% 10%,rgba(15,118,110,0.3) 0%,transparent 50%)}
.bingo-masthead-inner{position:relative;z-index:1;display:flex;align-items:flex-start;justify-content:space-between;gap:16px;flex-wrap:wrap}
.bingo-masthead-left{}
.bingo-game-label{font-size:0.52rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(255,255,255,0.35);margin-bottom:4px}
.bingo-title{font-family:'Bebas Neue',sans-serif;font-size:2.4rem;letter-spacing:4px;color:white;line-height:1;margin-bottom:3px}
.bingo-category{font-size:0.78rem;font-weight:600;color:rgba(255,255,255,0.55);margin-bottom:10px}
.bingo-counters{display:flex;gap:0;border:1px solid rgba(255,255,255,0.12);border-radius:10px;overflow:hidden}
.bingo-counter{padding:8px 14px;text-align:center;border-right:1px solid rgba(255,255,255,0.08)}
.bingo-counter:last-child{border-right:none}
.bingo-counter-num{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:1px;color:white;line-height:1}
.bingo-counter-lbl{font-size:0.48rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:rgba(255,255,255,0.35)}
.bingo-masthead-right{flex-shrink:0}
.bingo-progress-ring-wrap{position:relative;width:72px;height:72px}
.bingo-progress-ring-wrap svg{transform:rotate(-90deg)}
.bingo-progress-ring-bg{fill:none;stroke:rgba(255,255,255,0.08);stroke-width:5}
.bingo-progress-ring-fill{fill:none;stroke:var(--bingo);stroke-width:5;stroke-linecap:round;stroke-dasharray:188.5;stroke-dashoffset:188.5;transition:stroke-dashoffset 0.5s ease}
.bingo-progress-ring-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.bingo-progress-ring-pct{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1px;color:white;line-height:1}
.bingo-progress-ring-sub{font-size:0.4rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:rgba(255,255,255,0.35)}

/* Bingo line tracker */
.bingo-lines-bar{display:flex;gap:6px;margin-bottom:14px;align-items:center;padding:10px 14px;background:var(--white);border:1.5px solid var(--edge);border-radius:12px}
.bingo-lines-label{font-size:0.58rem;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-right:4px;white-space:nowrap}
.bingo-line-pip{flex:1;height:6px;border-radius:3px;background:var(--edge);transition:background 0.4s ease}
.bingo-line-pip.lit{background:var(--bingo)}
.bingo-lines-count{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;letter-spacing:1px;color:var(--bingo);margin-left:4px}

/* Bingo grid */
.bingo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:14px}
.bingo-cell{background:var(--white);border:1.5px solid var(--edge);border-radius:10px;padding:9px 5px;text-align:center;font-size:0.68rem;font-weight:700;min-height:64px;display:flex;align-items:center;justify-content:center;line-height:1.25;transition:all 0.18s;position:relative;cursor:default;color:var(--ink)}
.bingo-cell-num{position:absolute;top:4px;left:6px;font-size:0.45rem;font-weight:800;color:var(--edge);letter-spacing:0.5px}
.bingo-cell.selectable{cursor:pointer;border-color:rgba(15,118,110,0.35);background:#F5FEFA}
.bingo-cell.selectable:hover{background:#E6FAF5;border-color:var(--bingo);transform:translateY(-1px);box-shadow:0 3px 10px rgba(15,118,110,0.15)}
.bingo-cell.selected{background:var(--ink);border-color:var(--ink);color:white;transform:translateY(-2px);box-shadow:0 5px 16px rgba(12,12,12,0.3)}
.bingo-cell.marked{background:#E6FAF5;border-color:var(--bingo);color:var(--bingo)}
.bingo-cell.marked .bingo-cell-check{display:block}
.bingo-cell-check{display:none;position:absolute;top:4px;right:5px;font-size:0.5rem;color:var(--bingo);font-weight:900}
.bingo-cell.wrong-flash{animation:shake 0.35s ease;background:#FEE2E2!important;border-color:#FCA5A5!important;color:var(--fail)!important}
.bingo-cell.bingo-line{background:var(--bingo);border-color:var(--bingo);color:white;box-shadow:0 2px 8px rgba(15,118,110,0.35)}
.bingo-cell.bingo-line .bingo-cell-check{display:block;color:rgba(255,255,255,0.7)}
.bingo-cell.bingo-line .bingo-cell-num{color:rgba(255,255,255,0.3)}

/* Bingo prompt area */
.bingo-prompt-area{background:var(--white);border:2px solid var(--ink);border-radius:16px;overflow:hidden;margin-bottom:12px;box-shadow:3px 3px 0 var(--ink)}
.bingo-prompt-head{background:var(--ink);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.bingo-prompt-head-label{font-size:0.58rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.35)}
.bingo-prompt-counter{font-family:'Bebas Neue',sans-serif;font-size:1rem;letter-spacing:1px;color:white}
.bingo-prompt-body{padding:16px 18px 14px}
.bingo-prompt-text{font-size:1.15rem;font-weight:800;color:var(--ink);line-height:1.35;margin-bottom:4px}
.bingo-prompt-hint{font-size:0.7rem;font-weight:500;color:var(--muted);margin-bottom:14px}
.bingo-prompt-hint.active{color:var(--bingo);font-weight:600}
.bingo-prompt-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn-bingo-confirm{font-family:'Outfit',sans-serif;font-size:0.78rem;font-weight:800;padding:9px 22px;background:var(--ink);color:white;border:none;border-radius:100px;cursor:pointer;transition:all 0.14s}
.btn-bingo-confirm:hover:not([disabled]){background:#252525;transform:translateY(-1px);box-shadow:0 5px 14px rgba(0,0,0,0.2)}
.btn-bingo-confirm[disabled]{opacity:0.25;cursor:not-allowed}
.btn-bingo-skip{font-family:'Outfit',sans-serif;font-size:0.78rem;font-weight:600;padding:9px 18px;background:none;color:var(--muted);border:1.5px solid var(--edge);border-radius:100px;cursor:pointer;transition:all 0.14s}
.btn-bingo-skip:hover{border-color:var(--ink);color:var(--ink)}

/* Bingo feedback */
.bingo-feedback-strip{height:3px;background:var(--edge);transition:background 0.3s;border-radius:2px;margin-bottom:10px}
.bingo-feedback-strip.correct{background:var(--ok)}
.bingo-feedback-strip.wrong{background:var(--fail)}
.bingo-feedback-msg{font-size:0.78rem;font-weight:700;min-height:20px;padding:8px 12px;border-radius:8px;display:none;margin-bottom:10px}
.bingo-feedback-msg.show{display:block}
.bingo-feedback-msg.correct{background:var(--ok-tint);color:var(--ok);border:1px solid #86EFAC}
.bingo-feedback-msg.wrong{background:#FEE2E2;color:var(--fail);border:1px solid #FCA5A5}

/* Bingo complete */
.bingo-complete-wrap{background:var(--ink);border-radius:16px;padding:32px 24px;text-align:center;color:white;margin-top:16px;border:2px solid var(--ink);box-shadow:4px 4px 0 var(--ink)}
.bingo-complete-title{font-family:'DM Serif Display',serif;font-size:2.2rem;font-style:italic;margin-bottom:8px}
.bingo-complete-sub{font-size:0.78rem;font-weight:500;color:rgba(255,255,255,0.45);line-height:1.8;margin-bottom:20px}
.bingo-win-banner{background:var(--bingo);border-radius:10px;padding:12px 16px;margin-bottom:12px;text-align:center;animation:riseIn 0.4s ease}
.bingo-win-banner-title{font-family:'Bebas Neue',sans-serif;font-size:1.6rem;letter-spacing:3px;color:white;margin-bottom:2px}
.bingo-win-banner-sub{font-size:0.7rem;font-weight:600;color:rgba(255,255,255,0.75)}

/* ═══════════════════════════════════════════════ HOW TO PLAY OVERLAY */
.overlay{display:none;position:fixed;inset:0;background:rgba(12,12,12,0.65);z-index:400;align-items:center;justify-content:center;backdrop-filter:blur(5px)}
.overlay.show{display:flex}
.overlay-card{background:var(--white);border-radius:20px;padding:30px 28px 24px;max-width:440px;width:92%;animation:riseIn 0.3s cubic-bezier(0.22,1,0.36,1) both;border:2px solid var(--ink);box-shadow:6px 6px 0 var(--ink);max-height:90vh;overflow-y:auto}
.overlay-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;gap:10px}
.overlay-title{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:3px}
.overlay-game-badge{font-size:0.58rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;padding:4px 10px;border-radius:6px;color:white;white-space:nowrap;margin-top:6px}
.overlay-steps{display:flex;flex-direction:column;gap:12px;margin-bottom:22px;margin-top:14px}
.overlay-step{display:flex;align-items:flex-start;gap:12px}
.step-num{width:24px;height:24px;border-radius:7px;background:var(--ink);color:white;display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:800;flex-shrink:0;margin-top:2px}
.step-text{font-size:0.78rem;font-weight:500;color:#444;line-height:1.55}
.step-text strong{color:var(--ink);font-weight:800}
.btn-play{width:100%;padding:13px;background:var(--ink);color:white;border:none;border-radius:100px;font-family:'Outfit',sans-serif;font-size:0.85rem;font-weight:800;cursor:pointer;transition:background 0.14s}
.btn-play:hover{background:#252525}

/* ═══════════════════════════════════════════════ ANIMATIONS */
@keyframes riseIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-4px)}80%{transform:translateX(4px)}}
@keyframes starPop{from{transform:scale(0) rotate(-30deg);opacity:0}65%{transform:scale(1.45) rotate(8deg)}to{transform:scale(1) rotate(0);opacity:1}}
@keyframes correctPulse{0%{box-shadow:0 0 0 0 rgba(14,165,114,0.5)}70%{box-shadow:0 0 0 10px rgba(14,165,114,0)}100%{box-shadow:0 0 0 0 rgba(14,165,114,0)}}

/* ═══════════════════════════════════════════════ RESPONSIVE */
@media(max-width:600px){
  .home-game-grid{grid-template-columns:repeat(2,1fr)}
  .header-nav .nav-btn:not(.admin-btn){display:none}
  .r4-hero-cards{grid-template-columns:repeat(2,1fr)}
  .rank-row{padding:12px 8px 8px}
  .rank-tile{font-size:0.6rem;height:54px;border-radius:9px;padding:4px 2px}
  .rank-arrow{font-size:0.6rem;margin-top:27px}
  .rank-num{font-size:0.5rem}
  .item-fact{font-size:0.5rem;min-height:14px}
  .p3-grid{grid-template-columns:repeat(3,1fr)}
  .bingo-grid{grid-template-columns:repeat(4,1fr)}
  .bingo-cell{font-size:0.62rem;padding:7px 4px;min-height:54px}
  .form-row{grid-template-columns:1fr}
  .form-row.four{grid-template-columns:repeat(2,1fr)}
  .r4-answer-cat{min-width:100px}
}
@media(max-width:380px){
  .rank-tile{font-size:0.55rem;height:48px}
  .bingo-cell{font-size:0.58rem;min-height:48px}
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="site-logo" onclick="showPage('home')">
    <span>R</span><span>A</span><span>N</span><span>K</span>&nbsp;4
  </div>
  <div class="header-nav">
    <button class="nav-btn" onclick="showPage('rank4')">Rank 4</button>
    <button class="nav-btn" onclick="showPage('perfect3')">Perfect 3s</button>
    <button class="nav-btn" onclick="showPage('buildline')">Build the Line</button>
    <button class="nav-btn" onclick="showPage('bingo')">Trivia Bingo</button>
    <button class="nav-btn" onclick="showPage('howtoplay')">How to Play</button>
    <button class="nav-btn" onclick="showPage('archive')">Archive</button>
    <button class="nav-btn admin-btn" onclick="showPage('admin')">⚙</button>
  </div>
</header>

<!-- ══════════════════ HOME PAGE ══════════════════ -->
<div class="page" id="page-home">
  <div class="home-hero">
    <div class="home-hero-inner">
      <div class="home-eyebrow">Daily Puzzle Games</div>
      <div class="home-title">
        <span style="color:var(--c0)">R</span><span style="color:var(--c1)">A</span><span style="color:var(--c2)">N</span><span style="color:var(--c3)">K</span> 4
      </div>
      <div class="home-sub">Four daily puzzles. Rank, group, build, and bingo your way through the day.</div>
      <div class="home-game-grid">
        <div class="home-game-card hgc-rank4" onclick="showPage('rank4')">
          <span class="hgc-emoji">🏆</span>
          <span class="hgc-name">Rank 4</span>
          <span class="hgc-tag">Ranking · Pairs</span>
        </div>
        <div class="home-game-card hgc-p3" onclick="showPage('perfect3')">
          <span class="hgc-emoji">🎯</span>
          <span class="hgc-name">Perfect 3s</span>
          <span class="hgc-tag">Grouping</span>
        </div>
        <div class="home-game-card hgc-btl" onclick="showPage('buildline')">
          <span class="hgc-emoji">📏</span>
          <span class="hgc-name">Build the Line</span>
          <span class="hgc-tag">Ordering</span>
        </div>
        <div class="home-game-card hgc-bingo" onclick="showPage('bingo')">
          <span class="hgc-emoji">🎱</span>
          <span class="hgc-name">Trivia Bingo</span>
          <span class="hgc-tag">Trivia · Bingo</span>
        </div>
      </div>
    </div>
  </div>
  <div class="home-section">
    <div class="home-section-label">Today's Games</div>
    <div id="homeTodayCards"></div>
  </div>
</div>

<!-- ══════════════════ HOW TO PLAY PAGE ══════════════════ -->
<div class="page" id="page-howtoplay">
  <div class="game-wrap">
    <div class="game-back-bar">
      <button class="back-btn" onclick="showPage('home')">← Home</button>
      <div class="game-title-bar"><div class="game-title-label">How to Play</div></div>
    </div>
    <div class="htp-wrap">
      <!-- RANK 4 -->
      <div class="htp-section htp-section-rank4">
        <div class="htp-game-name" style="color:var(--c0)">Rank 4</div>
        <span class="htp-game-tag">Ranking &amp; Pair-Finding</span>
        <div class="htp-steps">
          <div class="htp-step"><div class="htp-step-num htp-step-num-rank4">1</div><div class="htp-step-text">You have <strong>4 items</strong> and <strong>4 ranking categories</strong>. Drag the items into order for each category — <strong>1st = least, 4th = most</strong>.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-rank4">2</div><div class="htp-step-text">Use <strong>Check Order</strong> to verify a category. You have <strong>3 checks shared</strong> across all categories — a star lights up when a row is perfect.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-rank4">3</div><div class="htp-step-text"><strong>Two categories share the exact same ranking order.</strong> Select both and press <strong>Link Pair</strong> to finish the game.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-rank4">4</div><div class="htp-step-text">If your orders are correct when you link, you earn <strong>4/4 stars automatically</strong> — no Check needed!</div></div>
        </div>
        <button class="htp-play-btn" style="background:var(--c0)" onclick="showPage('rank4')">Play Rank 4</button>
      </div>
      <!-- PERFECT 3s -->
      <div class="htp-section htp-section-p3">
        <div class="htp-game-name" style="color:var(--p3-a)">Perfect 3s</div>
        <span class="htp-game-tag">Grouping</span>
        <div class="htp-steps">
          <div class="htp-step"><div class="htp-step-num htp-step-num-p3">1</div><div class="htp-step-text">You are shown <strong>9 items</strong> from a shared theme, secretly split into <strong>3 groups of 3</strong>.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-p3">2</div><div class="htp-step-text">Tap items to select them. When you have <strong>3 selected</strong>, press <strong>Submit Group</strong> to check if they belong together.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-p3">3</div><div class="htp-step-text">You have <strong>3 attempts</strong>. A wrong guess costs one attempt. Find all three groups before you run out!</div></div>
        </div>
        <button class="htp-play-btn" style="background:var(--p3-a)" onclick="showPage('perfect3')">Play Perfect 3s</button>
      </div>
      <!-- BUILD THE LINE -->
      <div class="htp-section htp-section-btl">
        <div class="htp-game-name" style="color:var(--btl)">Build the Line</div>
        <span class="htp-game-tag">Ordering</span>
        <div class="htp-steps">
          <div class="htp-step"><div class="htp-step-num htp-step-num-btl">1</div><div class="htp-step-text">Items are revealed <strong>one at a time</strong>. Place each one on the line where you think it belongs — from smallest to largest.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-btl">2</div><div class="htp-step-text">Tap any <strong>gap on the line</strong> to insert the current item at that position.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-btl">3</div><div class="htp-step-text">Points are awarded by <strong>how close</strong> your placement is to the correct position. Exact = <strong>3 pts</strong>, 1 off = <strong>2 pts</strong>, 2 off = <strong>1 pt</strong>, 3+ off = <strong>0 pts</strong>. Score is shown out of 21.</div></div>
        </div>
        <button class="htp-play-btn" style="background:var(--btl)" onclick="showPage('buildline')">Play Build the Line</button>
      </div>
      <!-- TRIVIA BINGO -->
      <div class="htp-section htp-section-bingo">
        <div class="htp-game-name" style="color:var(--bingo)">Trivia Bingo</div>
        <span class="htp-game-tag">Trivia &amp; Pattern-Finding</span>
        <div class="htp-steps">
          <div class="htp-step"><div class="htp-step-num htp-step-num-bingo">1</div><div class="htp-step-text">A <strong>4×4 grid</strong> of category labels is shown. Each square describes a property (e.g. "Mammal", "Has Gills").</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-bingo">2</div><div class="htp-step-text">A <strong>trivia prompt</strong> appears (e.g. "A kangaroo"). Tap the square on the grid that you think matches, then press <strong>Confirm</strong>.</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-bingo">3</div><div class="htp-step-text">Correct answers <strong>mark that square</strong>. Complete a full row, column, or diagonal to score a <strong>Bingo</strong> line!</div></div>
          <div class="htp-step"><div class="htp-step-num htp-step-num-bingo">4</div><div class="htp-step-text">If no square fits, press <strong>Skip</strong>. Wrong guesses cost you a prompt. Fill the whole board to win!</div></div>
        </div>
        <button class="htp-play-btn" style="background:var(--bingo)" onclick="showPage('bingo')">Play Trivia Bingo</button>
      </div>
    </div>
  </div>
</div>

<!-- ══════════════════ RANK 4 PAGE ══════════════════ -->
<div class="page" id="page-rank4">
  <div class="rank4-hero" id="r4Hero">
    <div class="rank4-hero-inner">
      <div class="r4-eyebrow">Today's puzzle</div>
      <div class="r4-heading">Today's Items</div>
      <div class="r4-sub">Rank all four across four categories — then find the matching pair</div>
      <div class="r4-hero-cards" id="r4HeroCards"></div>
    </div>
  </div>
  <div class="r4-progress" id="r4Progress">
    <div class="r4-progress-inner">
      <span class="progress-label">Categories</span>
      <div class="progress-pips" id="r4Pips"></div>
      <div class="progress-checks">Checks<div class="check-pips" id="r4CheckPips"></div></div>
      <div class="progress-pair">Pair<div class="pair-pip" id="r4PairPip"></div></div>
    </div>
  </div>
  <div class="game-wrap">
    <div class="pair-box" id="r4PairBox">
      <div class="pair-head">
        <span class="pair-head-icon">🔗</span>
        <div class="pair-head-text">
          <div class="pair-head-title">Find the Matching Pair</div>
          <div class="pair-head-hint">Two categories share the exact same order — which ones?</div>
        </div>
      </div>
      <div class="pair-body">
        <div class="pair-pills" id="r4PairPills"></div>
        <div class="pair-foot">
          <button class="btn-link" id="r4BtnLink" disabled>Link Pair →</button>
          <span class="pair-msg" id="r4PairMsg">Select two categories above</span>
        </div>
        <div class="pair-wrong-reveal" id="r4WrongReveal">
          <div class="pair-wrong-title">⚠️ Close! Here's what each category actually ranked:</div>
          <div class="pair-wrong-rows" id="r4WrongRows"></div>
          <div class="swap-hint" id="r4SwapHint"></div>
        </div>
      </div>
    </div>
    <div class="cats-list" id="r4CatsList"></div>
    <div class="r4-results" id="r4Results">
      <div class="r4-res-card">
        <div class="r4-res-stripe" id="r4ResStripe"></div>
        <div class="r4-res-body" id="r4ResBody">
          <div id="r4WinContent">
            <div class="r4-res-logo">
              <span class="r4-res-logo-r">R</span><span class="r4-res-logo-a">A</span><span class="r4-res-logo-n">N</span><span class="r4-res-logo-k">K</span> <span style="color:rgba(255,255,255,0.9)">4</span>
            </div>
            <div class="r4-res-date" id="r4ResDate"></div>
            <div class="r4-res-pair-label">Matching Pair</div>
            <div class="r4-res-pair-stat">
              <span class="r4-res-pair-icon">🔗</span>
              <span class="r4-res-pair-found">Found!</span>
            </div>
            <div class="r4-stars-row" id="r4StarsRow"></div>
            <div class="r4-score-sub" id="r4ScoreSub"></div>
            <div class="r4-share-box" id="r4ShareBox"></div>
            <div class="r4-share-prompt">Play at <a href="#" target="_blank">rank4daily.com</a></div>
            <button class="btn-copy" id="r4BtnCopy">Copy Result</button>
          </div>
          <div id="r4FailContent" style="display:none">
            <div class="r4-fail-icon">💔</div>
            <div class="r4-fail-heading">Unlucky!</div>
            <div class="r4-fail-sub" id="r4FailSub"></div>
            <div class="r4-res-date" id="r4ResDateFail"></div>
            <div class="r4-share-box" id="r4ShareBoxFail"></div>
            <div class="r4-share-prompt">Play at <a href="#" target="_blank">rank4daily.com</a></div>
            <button class="btn-copy" id="r4BtnCopyFail">Copy Result</button>
          </div>
        </div>
      </div>
      <div class="r4-answers">
        <div class="r4-answers-label">Today's Correct Orders</div>
        <div class="r4-answer-rows" id="r4AnswerRows"></div>
      </div>
    </div>
  </div>
  <div class="checks-toast" id="r4Toast"></div>

  <!-- Rank 4 How to Play Overlay -->
  <div class="overlay" id="r4HelpOverlay" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="overlay-card">
      <div class="overlay-top">
        <div class="overlay-title">How to Play</div>
        <div class="overlay-game-badge" style="background:var(--c0)">Rank 4</div>
      </div>
      <div class="overlay-steps">
        <div class="overlay-step"><div class="step-num" style="background:var(--c0)">1</div><div class="step-text">You have <strong>4 items</strong> and <strong>4 ranking categories</strong>. Drag items to rank them — <strong>1st = least, 4th = most</strong>.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--c1)">2</div><div class="step-text">You have <strong>3 Check Order attempts</strong> shared across all categories. A ⭐ lights up when a row is correct.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--c2)">3</div><div class="step-text">Exactly <strong>two categories share the same ranking order</strong>. Select both and hit <strong>Link Pair</strong> to end the game.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--c3)">4</div><div class="step-text">If your orders are correct when you link, you get <strong>4/4 stars automatically</strong> — no Check needed!</div></div>
      </div>
      <button class="btn-play" onclick="document.getElementById('r4HelpOverlay').classList.remove('show')">Let's go!</button>
    </div>
  </div>
</div>

<!-- ══════════════════ PERFECT 3s PAGE ══════════════════ -->
<div class="page" id="page-perfect3">
  <div class="game-wrap">
    <div class="game-back-bar">
      <button class="back-btn" onclick="showPage('home')">← Home</button>
      <div class="game-title-bar"><div class="game-title-label" style="color:var(--p3-a)">Perfect 3s</div></div>
    </div>
    <div class="p3-wrap" id="p3Wrap"></div>
  </div>

  <!-- Perfect 3s How to Play Overlay -->
  <div class="overlay" id="p3HelpOverlay" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="overlay-card">
      <div class="overlay-top">
        <div class="overlay-title">How to Play</div>
        <div class="overlay-game-badge" style="background:var(--p3-a)">Perfect 3s</div>
      </div>
      <div class="overlay-steps">
        <div class="overlay-step"><div class="step-num" style="background:var(--p3-a)">1</div><div class="step-text">You are shown <strong>9 items</strong> secretly split into <strong>3 groups of 3</strong>, all sharing a theme.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--p3-b)">2</div><div class="step-text">Tap to select <strong>3 items</strong> that belong together, then press <strong>Submit Group</strong>.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--p3-c)">3</div><div class="step-text">You have <strong>3 attempts</strong> — a wrong guess costs one. Find all three groups to win!</div></div>
      </div>
      <button class="btn-play" onclick="document.getElementById('p3HelpOverlay').classList.remove('show')">Let's go!</button>
    </div>
  </div>
</div>

<!-- ══════════════════ BUILD THE LINE PAGE ══════════════════ -->
<div class="page" id="page-buildline">
  <div class="game-wrap">
    <div class="game-back-bar">
      <button class="back-btn" onclick="showPage('home')">← Home</button>
      <div class="game-title-bar"><div class="game-title-label" style="color:var(--btl)">Build the Line</div></div>
    </div>
    <div class="btl-wrap" id="btlWrap"></div>
  </div>

  <!-- Build the Line How to Play Overlay -->
  <div class="overlay" id="btlHelpOverlay" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="overlay-card">
      <div class="overlay-top">
        <div class="overlay-title">How to Play</div>
        <div class="overlay-game-badge" style="background:var(--btl)">Build the Line</div>
      </div>
      <div class="overlay-steps">
        <div class="overlay-step"><div class="step-num" style="background:var(--btl)">1</div><div class="step-text">Items are revealed <strong>one at a time</strong>. Tap a gap on the line to place each item where you think it belongs — smallest to largest.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--btl)">2</div><div class="step-text">Points are awarded by <strong>how close your placement is</strong>. Exact position = <strong>3 pts</strong>, 1 off = <strong>2 pts</strong>, 2 off = <strong>1 pt</strong>, 3+ off = 0 pts.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--btl)">3</div><div class="step-text">Score is shown <strong>out of 21</strong>. After all items are placed, the correct positions are revealed.</div></div>
      </div>
      <button class="btn-play" onclick="document.getElementById('btlHelpOverlay').classList.remove('show')">Let's go!</button>
    </div>
  </div>
</div>

<!-- ══════════════════ TRIVIA BINGO PAGE ══════════════════ -->
<div class="page" id="page-bingo">
  <div class="game-wrap">
    <div class="game-back-bar">
      <button class="back-btn" onclick="showPage('home')">← Home</button>
      <div class="game-title-bar"><div class="game-title-label" style="color:var(--bingo)">Trivia Bingo</div></div>
    </div>
    <div class="bingo-wrap" id="bingoWrap"></div>
  </div>

  <!-- Bingo How to Play Overlay -->
  <div class="overlay" id="bingoHelpOverlay" onclick="if(event.target===this)this.classList.remove('show')">
    <div class="overlay-card">
      <div class="overlay-top">
        <div class="overlay-title">How to Play</div>
        <div class="overlay-game-badge" style="background:var(--bingo)">Trivia Bingo</div>
      </div>
      <div class="overlay-steps">
        <div class="overlay-step"><div class="step-num" style="background:var(--bingo)">1</div><div class="step-text">A <strong>4×4 grid</strong> shows category labels. A trivia <strong>prompt</strong> appears — tap the square that matches and press <strong>Confirm</strong>.</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--bingo)">2</div><div class="step-text">Correct answers <strong>mark that square</strong>. Complete a row, column, or diagonal to score a <strong>Bingo</strong>!</div></div>
        <div class="overlay-step"><div class="step-num" style="background:var(--bingo)">3</div><div class="step-text">If no square fits, press <strong>Skip</strong>. Wrong guesses cost you a prompt. <strong>Fill the board</strong> to win!</div></div>
      </div>
      <button class="btn-play" onclick="document.getElementById('bingoHelpOverlay').classList.remove('show')">Let's go!</button>
    </div>
  </div>
</div>

<!-- ══════════════════ ARCHIVE PAGE ══════════════════ -->
<div class="page" id="page-archive">
  <div class="game-wrap">
    <div class="game-back-bar">
      <button class="back-btn" onclick="showPage('home')">← Home</button>
      <div class="game-title-bar"><div class="game-title-label">Archive</div></div>
    </div>
    <div id="archiveContent"></div>
  </div>
</div>

<!-- ══════════════════ ADMIN PAGE ══════════════════ -->
<div class="page" id="page-admin">
  <div class="game-wrap">
    <div id="adminLoginWrap">
      <div class="admin-login">
        <div class="admin-login-title">Admin Panel</div>
        <div class="admin-login-sub">Enter your password to manage puzzles</div>
        <input class="admin-pw-field" type="password" id="adminPwInput" placeholder="Password" onkeydown="if(event.key==='Enter')adminLogin()">
        <button class="admin-login-btn" onclick="adminLogin()">Enter</button>
        <div class="admin-err" id="adminErr"></div>
      </div>
    </div>
    <div id="adminPanelWrap" style="display:none">
      <div class="admin-panel">
        <div class="admin-section-title">Puzzle Manager</div>
        <div class="admin-section-sub">Add or edit daily puzzles for all games. Changes are saved in your browser.</div>
        <div class="admin-tabs">
          <button class="admin-tab active" onclick="switchAdminTab('rank4')">Rank 4</button>
          <button class="admin-tab" onclick="switchAdminTab('perfect3')">Perfect 3s</button>
          <button class="admin-tab" onclick="switchAdminTab('buildline')">Build the Line</button>
          <button class="admin-tab" onclick="switchAdminTab('bingo')">Trivia Bingo</button>
        </div>
        <!-- RANK 4 ADMIN -->
        <div class="admin-tab-content active" id="admintab-rank4">
          <div class="admin-card">
            <div class="admin-card-title"><span>➕</span> Add Rank 4 Puzzle</div>
            <div class="form-row">
              <div><label class="form-label">Puzzle Date</label><input class="form-input" type="date" id="r4AdminDate"></div>
              <div><label class="form-label">Items (comma-separated)</label><input class="form-input" type="text" id="r4AdminItems" placeholder="e.g. Cat, Dog, Elephant, Blue Whale"></div>
            </div>
            <div class="form-row">
              <div><label class="form-label">Item Emojis (comma-separated, same order)</label><input class="form-input" type="text" id="r4AdminEmojis" placeholder="🐱, 🐶, 🐘, 🐋"></div>
            </div>
            <div id="r4AdminCatsWrap">
              <div style="margin-bottom:14px;padding:12px;background:var(--paper);border-radius:10px;border:1px solid var(--edge)">
                <div class="cat-color-row"><div class="cat-color-dot" style="background:var(--c0)"></div><span style="font-size:0.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--c0)">Category 1</span></div>
                <div class="form-row"><div><label class="form-label">Category Name</label><input class="form-input" type="text" id="r4c0name" placeholder="e.g. WEIGHT"></div><div><label class="form-label">Description</label><input class="form-input" type="text" id="r4c0desc" placeholder="e.g. Lightest → Heaviest"></div></div>
                <label class="form-label">Correct Order (1st to 4th)</label><input class="form-input" type="text" id="r4c0order" placeholder="e.g. Cat, Dog, Elephant, Blue Whale">
                <label class="form-label" style="margin-top:10px">Facts per item (comma-separated)</label><input class="form-input" type="text" id="r4c0facts" placeholder="e.g. 4 kg, 30 kg, 4000 kg, 150000 kg">
              </div>
              <div style="margin-bottom:14px;padding:12px;background:var(--paper);border-radius:10px;border:1px solid var(--edge)">
                <div class="cat-color-row"><div class="cat-color-dot" style="background:var(--c1)"></div><span style="font-size:0.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--c1)">Category 2</span></div>
                <div class="form-row"><div><label class="form-label">Category Name</label><input class="form-input" type="text" id="r4c1name" placeholder="e.g. LENGTH"></div><div><label class="form-label">Description</label><input class="form-input" type="text" id="r4c1desc" placeholder="e.g. Shortest → Longest"></div></div>
                <label class="form-label">Correct Order (1st to 4th)</label><input class="form-input" type="text" id="r4c1order" placeholder="e.g. Cat, Dog, Elephant, Blue Whale">
                <label class="form-label" style="margin-top:10px">Facts per item (comma-separated)</label><input class="form-input" type="text" id="r4c1facts" placeholder="e.g. 30cm, 50cm, 3m, 30m">
              </div>
              <div style="margin-bottom:14px;padding:12px;background:var(--paper);border-radius:10px;border:1px solid var(--edge)">
                <div class="cat-color-row"><div class="cat-color-dot" style="background:var(--c2)"></div><span style="font-size:0.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--c2)">Category 3</span></div>
                <div class="form-row"><div><label class="form-label">Category Name</label><input class="form-input" type="text" id="r4c2name" placeholder="e.g. AGE"></div><div><label class="form-label">Description</label><input class="form-input" type="text" id="r4c2desc" placeholder="e.g. Newest → Oldest"></div></div>
                <label class="form-label">Correct Order (1st to 4th)</label><input class="form-input" type="text" id="r4c2order" placeholder="e.g. Cat, Dog, Elephant, Blue Whale">
                <label class="form-label" style="margin-top:10px">Facts per item (comma-separated)</label><input class="form-input" type="text" id="r4c2facts" placeholder="e.g. 10yrs, 50yrs, 100yrs, 1000yrs">
              </div>
              <div style="margin-bottom:14px;padding:12px;background:var(--paper);border-radius:10px;border:1px solid var(--edge)">
                <div class="cat-color-row"><div class="cat-color-dot" style="background:var(--c3)"></div><span style="font-size:0.65rem;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:var(--c3)">Category 4</span></div>
                <div class="form-row"><div><label class="form-label">Category Name</label><input class="form-input" type="text" id="r4c3name" placeholder="e.g. SPEED"></div><div><label class="form-label">Description</label><input class="form-input" type="text" id="r4c3desc" placeholder="e.g. Slowest → Fastest"></div></div>
                <label class="form-label">Correct Order (1st to 4th)</label><input class="form-input" type="text" id="r4c3order" placeholder="e.g. Cat, Dog, Elephant, Blue Whale">
                <label class="form-label" style="margin-top:10px">Facts per item (comma-separated)</label><input class="form-input" type="text" id="r4c3facts" placeholder="e.g. 5mph, 15mph, 25mph, 60mph">
              </div>
            </div>
            <div class="form-row">
              <div>
                <label class="form-label">Matching Pair (indices 0–3)</label>
                <input class="form-input" type="text" id="r4AdminPair" placeholder="e.g. 0,2 (Category 1 and 3 match)">
                <div class="form-hint">0=Cat1, 1=Cat2, 2=Cat3, 3=Cat4</div>
              </div>
            </div>
            <button class="btn-admin-save" onclick="saveR4Puzzle()">💾 Save Puzzle</button>
            <span class="admin-save-msg" id="r4SaveMsg">Saved!</span>
          </div>
          <div class="admin-card">
            <div class="admin-card-title"><span>📋</span> Saved Rank 4 Puzzles</div>
            <div id="r4AdminList" class="admin-list"></div>
          </div>
        </div>
        <!-- PERFECT 3s ADMIN -->
        <div class="admin-tab-content" id="admintab-perfect3">
          <div class="admin-card">
            <div class="admin-card-title"><span>➕</span> Add Perfect 3s Puzzle</div>
            <div class="form-row">
              <div><label class="form-label">Puzzle Date</label><input class="form-input" type="date" id="p3AdminDate"></div>
              <div><label class="form-label">Theme / Title</label><input class="form-input" type="text" id="p3AdminTheme" placeholder="e.g. Tom Hanks Universe"></div>
            </div>
            <div style="margin-bottom:12px;padding:14px;background:rgba(124,58,237,0.05);border-radius:10px;border:1.5px solid rgba(124,58,237,0.2)">
              <div style="font-size:0.6rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--p3-a);margin-bottom:10px">Group 1 (Purple)</div>
              <div class="form-row"><div><label class="form-label">Group Name</label><input class="form-input" type="text" id="p3g0name" placeholder="e.g. Tom Hanks Movies"></div></div>
              <label class="form-label">3 Items (comma-separated)</label>
              <input class="form-input" type="text" id="p3g0items" placeholder="e.g. Cast Away, Forrest Gump, The Green Mile">
            </div>
            <div style="margin-bottom:12px;padding:14px;background:rgba(219,39,119,0.05);border-radius:10px;border:1.5px solid rgba(219,39,119,0.2)">
              <div style="font-size:0.6rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--p3-b);margin-bottom:10px">Group 2 (Pink)</div>
              <div class="form-row"><div><label class="form-label">Group Name</label><input class="form-input" type="text" id="p3g1name" placeholder="e.g. Ed Sheeran Songs"></div></div>
              <label class="form-label">3 Items (comma-separated)</label>
              <input class="form-input" type="text" id="p3g1items" placeholder="e.g. Shape of You, Bad Habits, Perfect">
            </div>
            <div style="margin-bottom:12px;padding:14px;background:rgba(2,132,199,0.05);border-radius:10px;border:1.5px solid rgba(2,132,199,0.2)">
              <div style="font-size:0.6rem;font-weight:800;letter-spacing:1.5px;text-transform:uppercase;color:var(--p3-c);margin-bottom:10px">Group 3 (Blue)</div>
              <div class="form-row"><div><label class="form-label">Group Name</label><input class="form-input" type="text" id="p3g2name" placeholder="e.g. Planets with Rings"></div></div>
              <label class="form-label">3 Items (comma-separated)</label>
              <input class="form-input" type="text" id="p3g2items" placeholder="e.g. Saturn, Jupiter, Uranus">
            </div>
            <button class="btn-admin-save" onclick="saveP3Puzzle()">💾 Save Puzzle</button>
            <span class="admin-save-msg" id="p3SaveMsg">Saved!</span>
          </div>
          <div class="admin-card">
            <div class="admin-card-title"><span>📋</span> Saved Perfect 3s Puzzles</div>
            <div id="p3AdminList" class="admin-list"></div>
          </div>
        </div>
        <!-- BUILD THE LINE ADMIN -->
        <div class="admin-tab-content" id="admintab-buildline">
          <div class="admin-card">
            <div class="admin-card-title"><span>➕</span> Add Build the Line Puzzle</div>
            <div class="form-row">
              <div><label class="form-label">Puzzle Date</label><input class="form-input" type="date" id="btlAdminDate"></div>
              <div><label class="form-label">Category / Metric</label><input class="form-input" type="text" id="btlAdminCat" placeholder="e.g. Speed in km/h"></div>
            </div>
            <div class="form-row">
              <div><label class="form-label">Left End Label (smallest end)</label><input class="form-input" type="text" id="btlAdminLabelSmall" placeholder="e.g. Smallest or Earliest"></div>
              <div><label class="form-label">Right End Label (largest end)</label><input class="form-input" type="text" id="btlAdminLabelLarge" placeholder="e.g. Largest or Latest"></div>
            </div>
            <label class="form-label">Items in correct order: Left → Right (comma-separated)</label>
            <input class="form-input" type="text" id="btlAdminItems" placeholder="e.g. Snail, Walking Pace, Cycling, Car, Train, Plane, Rocket" style="margin-bottom:4px">
            <label class="form-label">Emojis (comma-separated)</label>
            <input class="form-input" type="text" id="btlAdminEmojis" placeholder="🐌, 🚶, 🚴, 🚗, 🚆, ✈️, 🚀" style="margin-bottom:10px">
            <label class="form-label">Values shown after game (comma-separated)</label>
            <input class="form-input" type="text" id="btlAdminValues" placeholder="e.g. 0.05 km/h, 5 km/h, 25 km/h...">
            <button class="btn-admin-save" onclick="saveBtlPuzzle()" style="margin-top:16px">💾 Save Puzzle</button>
            <span class="admin-save-msg" id="btlSaveMsg">Saved!</span>
          </div>
          <div class="admin-card">
            <div class="admin-card-title"><span>📋</span> Saved Build the Line Puzzles</div>
            <div id="btlAdminList" class="admin-list"></div>
          </div>
        </div>
        <!-- BINGO ADMIN -->
        <div class="admin-tab-content" id="admintab-bingo">
          <div class="admin-card">
            <div class="admin-card-title"><span>➕</span> Add Trivia Bingo Puzzle</div>
            <p style="font-size:0.72rem;color:var(--muted);margin-bottom:14px">Players see a prompt and tap ONE grid square that matches. Each prompt can match multiple squares — the player can tap any valid one.</p>
            <div class="form-row">
              <div><label class="form-label">Puzzle Date</label><input class="form-input" type="date" id="bingoAdminDate"></div>
              <div><label class="form-label">Category</label><input class="form-input" type="text" id="bingoAdminCat" placeholder="e.g. Animals"></div>
            </div>
            <label class="form-label">16 Grid Square Labels (comma-separated)</label>
            <textarea class="form-input" id="bingoAdminGrid" rows="3" placeholder="Native to Australia, Mammal, Reptile, Has Gills..." style="margin-bottom:6px"></textarea>
            <div class="form-hint" style="margin-bottom:12px">Squares 0–15 numbered left to right, top to bottom</div>
            <label class="form-label">Prompts — one per line. Format: <code style="background:var(--lift);padding:1px 5px;border-radius:4px;font-size:0.7rem">Prompt text | matching square index(es, comma-separated)</code></label>
            <div class="form-hint" style="margin-bottom:6px">A prompt can match multiple squares — player gets credit for choosing any of them.</div>
            <textarea class="form-input" id="bingoAdminPrompts" rows="14" placeholder="A lion | 1&#10;A shark | 3,6&#10;A kangaroo | 0&#10;A bat | 9"></textarea>
            <button class="btn-admin-save" onclick="saveBingoPuzzle()" style="margin-top:16px">💾 Save Puzzle</button>
            <span class="admin-save-msg" id="bingoSaveMsg">Saved!</span>
          </div>
          <div class="admin-card">
            <div class="admin-card-title"><span>📋</span> Saved Trivia Bingo Puzzles</div>
            <div id="bingoAdminList" class="admin-list"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// CHANGED: admin password updated to 4664
const ADMIN_PASSWORD = '4664';

const DEFAULT_R4_PUZZLES = [
  {date:'2025-01-01',items:['A4 Paper','Pencil','Elephant','Moon'],emojis:{'A4 Paper':'📄','Pencil':'✏️','Elephant':'🐘','Moon':'🌙'},
    categories:[
      {label:'WEIGHT',desc:'Lightest → Heaviest',order:['A4 Paper','Pencil','Elephant','Moon'],facts:{'A4 Paper':'~5 g','Pencil':'~10 g','Elephant':'~4,000 kg','Moon':'7.3×10²² kg'}},
      {label:'LENGTH',desc:'Shortest → Longest',order:['Pencil','A4 Paper','Elephant','Moon'],facts:{'Pencil':'~19 cm','A4 Paper':'29.7 cm','Elephant':'~6 m','Moon':'3,474 km Ø'}},
      {label:'VALUE IN $',desc:'Cheapest → Most Expensive',order:['A4 Paper','Pencil','Elephant','Moon'],facts:{'A4 Paper':'~$0.01','Pencil':'~$0.50','Elephant':'~$30,000','Moon':'incalculable'}},
      {label:'AGE',desc:'Oldest → Newest',order:['Moon','Elephant','A4 Paper','Pencil'],facts:{'Moon':'~4.5B yrs','Elephant':'~60M yrs','A4 Paper':'std. 1975','Pencil':'inv. 1565'}},
    ],matchingPair:[0,2]},
  {date:'2025-01-02',items:['Ant','Tennis Ball','Blue Whale','Eiffel Tower'],emojis:{'Ant':'🐜','Tennis Ball':'🎾','Blue Whale':'🐋','Eiffel Tower':'🗼'},
    categories:[
      {label:'WEIGHT',desc:'Lightest → Heaviest',order:['Ant','Tennis Ball','Blue Whale','Eiffel Tower'],facts:{'Ant':'~1 mg','Tennis Ball':'~58 g','Blue Whale':'~150,000 kg','Eiffel Tower':'~7,300 t'}},
      {label:'POPULATION',desc:'Fewest → Most',order:['Eiffel Tower','Blue Whale','Tennis Ball','Ant'],facts:{'Eiffel Tower':'1','Blue Whale':'~15,000','Tennis Ball':'~300M/yr','Ant':'~20 quadrillion'}},
      {label:'AGE',desc:'Newest → Oldest',order:['Eiffel Tower','Tennis Ball','Blue Whale','Ant'],facts:{'Eiffel Tower':'built 1889','Tennis Ball':'inv. ~1870s','Blue Whale':'~5M yrs','Ant':'~100M yrs'}},
      {label:'MARKET VALUE',desc:'Cheapest → Most Expensive',order:['Ant','Tennis Ball','Blue Whale','Eiffel Tower'],facts:{'Ant':'~$0','Tennis Ball':'~$3','Blue Whale':'~$1M','Eiffel Tower':'~$480B'}},
    ],matchingPair:[0,3]},
  {date:'2025-01-03',items:['Strawberry','Basketball','School Bus','Eiffel Tower'],emojis:{'Strawberry':'🍓','Basketball':'🏀','School Bus':'🚌','Eiffel Tower':'🗼'},
    categories:[
      {label:'WEIGHT',desc:'Lightest → Heaviest',order:['Strawberry','Basketball','School Bus','Eiffel Tower'],facts:{'Strawberry':'~12 g','Basketball':'~620 g','School Bus':'~10,000 kg','Eiffel Tower':'~7,300 t'}},
      {label:'HEIGHT',desc:'Shortest → Tallest',order:['Strawberry','Basketball','School Bus','Eiffel Tower'],facts:{'Strawberry':'~3 cm','Basketball':'~24 cm Ø','School Bus':'~3.5 m','Eiffel Tower':'330 m'}},
      {label:'INVENTION DATE',desc:'Most Recent → Oldest',order:['Basketball','Eiffel Tower','School Bus','Strawberry'],facts:{'Basketball':'inv. 1891','Eiffel Tower':'built 1889','School Bus':'1827','Strawberry':'~1300s'}},
      {label:'COST PER KG',desc:'Cheapest → Most Expensive/kg',order:['Eiffel Tower','School Bus','Strawberry','Basketball'],facts:{'Eiffel Tower':'~$7/kg','School Bus':'~$10/kg','Strawberry':'~$42/kg','Basketball':'~$48/kg'}},
    ],matchingPair:[0,1]},
];

const DEFAULT_P3_PUZZLES = [
  {date:'2025-01-01',theme:'Famous Fours',
    groups:[
      {name:'Tom Hanks Movies',items:['Cast Away','Forrest Gump','The Green Mile']},
      {name:'Ed Sheeran Songs',items:['Shape of You','Bad Habits','Perfect']},
      {name:'Planets with Rings',items:['Saturn','Jupiter','Uranus']},
    ]},
];

// CHANGED: default BTL puzzle includes labelSmall/labelLarge
const DEFAULT_BTL_PUZZLES = [
  {date:'2025-01-01',category:'Speed in km/h',labelSmall:'Smallest',labelLarge:'Largest',
    items:['Snail','Walking Pace','Cycling','Car','Train','Plane','Rocket'],
    emojis:['🐌','🚶','🚴','🚗','🚆','✈️','🚀'],
    values:['0.05 km/h','5 km/h','25 km/h','120 km/h','300 km/h','900 km/h','28,000 km/h']},
];

const DEFAULT_BINGO_PUZZLES = [
  {date:'2025-01-01',category:'Animals',
    grid:['Native to Australia','Mammal','Reptile','Has Gills','Lays Eggs','4 Legs','Lives in Ocean','Nocturnal','Has Fur','Can Fly','Endangered','Venomous','Warm-Blooded','Apex Predator','Has Tail','Social Animal'],
    prompts:[
      {text:'A kangaroo',matches:[0,1,4,8,14]},
      {text:'A great white shark',matches:[3,6,13,14]},
      {text:'A crocodile',matches:[2,4,5,11,14]},
      {text:'A bat',matches:[1,4,7,8,9,14]},
      {text:'An eagle',matches:[4,9,12,14]},
      {text:'A blue whale',matches:[1,4,6,8,10,12,14,15]},
      {text:'A platypus',matches:[0,1,4,8,11,14]},
      {text:'A lion',matches:[1,5,8,12,13,14,15]},
      {text:'A cobra',matches:[2,4,11,14]},
      {text:'A penguin',matches:[1,4,8,10,12,14]},
      {text:'A frog',matches:[2,4,5,14]},
      {text:'A firefly',matches:[4,7,9,14]},
      {text:'A dolphin',matches:[1,6,8,12,14,15]},
      {text:'A koala',matches:[0,1,7,8,10,14]},
      {text:'A honeybee',matches:[4,9,14,15]},
      {text:'A Komodo dragon',matches:[2,5,11,14]},
      {text:'A cheetah',matches:[1,5,8,12,13,14]},
      {text:'A salmon',matches:[3,4,14]},
      {text:'An owl',matches:[4,7,9,12,14]},
      {text:'A tarantula',matches:[7,11,14]},
      {text:'A wolf',matches:[1,5,8,12,13,14,15]},
      {text:'A sea turtle',matches:[2,4,6,10,14]},
      {text:'A gorilla',matches:[1,5,8,10,12,14,15]},
      {text:'A flamingo',matches:[4,9,12,14,15]},
      {text:'A polar bear',matches:[1,5,8,10,12,13,14]},
      {text:'A clownfish',matches:[3,6,14]},
      {text:'A tiger',matches:[1,5,8,12,13,14]},
      {text:'A python',matches:[2,4,14]},
      {text:'A rhino',matches:[1,5,8,10,12,14]},
      {text:'A hummingbird',matches:[4,9,12,14]},
      {text:'A meerkat',matches:[1,5,8,12,14,15]},
    ]},
];

// ═══════════════════════════════════════════════════════
// JSONBIN CLOUD STORAGE
// ═══════════════════════════════════════════════════════
const JSONBIN_BIN_ID = '6998797943b1c97be98e9aa5';
const JSONBIN_API_KEY = '$2a$10$SIQxm2NOgyIeYb.G/anmHOfT/bnRdUH3Dh13WZEOiGZDZ2Df//oTe';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

let _cloudCache = null;
let _cloudFetchPromise = null;

async function fetchCloudData() {
  if (_cloudCache) return _cloudCache;
  if (_cloudFetchPromise) return _cloudFetchPromise;
  _cloudFetchPromise = fetch(JSONBIN_URL + '/latest', {
    headers: { 'X-Master-Key': JSONBIN_API_KEY }
  })
  .then(r => r.json())
  .then(data => {
    const record = data.record || {};
    _cloudCache = {
      r4_puzzles:    record.r4_puzzles    && record.r4_puzzles.length    ? record.r4_puzzles    : DEFAULT_R4_PUZZLES,
      p3_puzzles:    record.p3_puzzles    && record.p3_puzzles.length    ? record.p3_puzzles    : DEFAULT_P3_PUZZLES,
      btl_puzzles:   record.btl_puzzles   && record.btl_puzzles.length   ? record.btl_puzzles   : DEFAULT_BTL_PUZZLES,
      bingo_puzzles: record.bingo_puzzles && record.bingo_puzzles.length ? record.bingo_puzzles : DEFAULT_BINGO_PUZZLES,
    };
    _cloudFetchPromise = null;
    return _cloudCache;
  })
  .catch(err => {
    console.warn('JSONBin fetch failed, using defaults:', err);
    _cloudFetchPromise = null;
    _cloudCache = {
      r4_puzzles: DEFAULT_R4_PUZZLES, p3_puzzles: DEFAULT_P3_PUZZLES,
      btl_puzzles: DEFAULT_BTL_PUZZLES, bingo_puzzles: DEFAULT_BINGO_PUZZLES
    };
    return _cloudCache;
  });
  return _cloudFetchPromise;
}

async function saveCloudData(updatedFields) {
  const current = await fetchCloudData();
  const merged = { ...current, ...updatedFields };
  _cloudCache = merged;
  await fetch(JSONBIN_URL, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'X-Master-Key': JSONBIN_API_KEY },
    body: JSON.stringify(merged)
  });
}

function getR4Puzzles()    { return (_cloudCache && _cloudCache.r4_puzzles)    || DEFAULT_R4_PUZZLES; }
function getP3Puzzles()    { return (_cloudCache && _cloudCache.p3_puzzles)    || DEFAULT_P3_PUZZLES; }
function getBtlPuzzles()   { return (_cloudCache && _cloudCache.btl_puzzles)   || DEFAULT_BTL_PUZZLES; }
function getBingoPuzzles() { return (_cloudCache && _cloudCache.bingo_puzzles) || DEFAULT_BINGO_PUZZLES; }

function getTodayStr(){return new Date().toISOString().slice(0,10);}
function getPuzzleForToday(puzzles){
  const today=getTodayStr();
  const exact=puzzles.find(p=>p.date===today);
  if(exact)return{puzzle:exact,idx:puzzles.indexOf(exact)};
  const d=new Date();
  const idx=Math.floor((d-new Date(d.getFullYear(),0,0))/86400000)%puzzles.length;
  return{puzzle:puzzles[idx],idx};
}

// ─── Page system ───
async function showPage(id){
  if(!_cloudCache){
    showLoader('Loading puzzles...');
    await fetchCloudData();
    hideLoader();
    renderHomeCards();
  }
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  window.scrollTo(0,0);
  if(id==='rank4'&&!r4State.initialized)initR4();
  if(id==='perfect3'&&!p3State.initialized)initP3();
  if(id==='buildline'&&!btlState.initialized)initBtl();
  if(id==='bingo'&&!bingoState.initialized)initBingo();
  if(id==='archive')renderArchive();
  if(id==='admin'){
    _cloudCache=null;
    showLoader('Loading latest puzzles...');
    await fetchCloudData();
    hideLoader();
    renderAdminLists();
    const today=getTodayStr();
    ['r4AdminDate','p3AdminDate','btlAdminDate','bingoAdminDate'].forEach(eid=>{const el=document.getElementById(eid);if(el)el.value=today;});
  }
}

// ─── Loading overlay ───
function showLoader(msg){
  var el=document.getElementById('globalLoader');
  if(!el){
    el=document.createElement('div');
    el.id='globalLoader';
    el.style.cssText='position:fixed;inset:0;background:#0C0C0C;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:16px';
    var logo=document.createElement('div');
    logo.style.cssText='font-size:3rem;letter-spacing:6px;color:white;font-weight:900';
    logo.innerHTML='<span style="color:#E8391E">R</span><span style="color:#F59E0B">A</span><span style="color:#0EA572">N</span><span style="color:#2F54EB">K</span> 4';
    var msgEl=document.createElement('div');
    msgEl.id='loaderMsg';
    msgEl.style.cssText='font-size:0.75rem;font-weight:600;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.4)';
    msgEl.textContent=msg||'Loading puzzles...';
    var track=document.createElement('div');
    track.style.cssText='width:120px;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;margin-top:4px';
    var bar=document.createElement('div');
    bar.id='loaderBar';
    bar.style.cssText='height:100%;background:linear-gradient(90deg,#E8391E,#F59E0B,#0EA572,#2F54EB);width:0;transition:width 1.4s ease;border-radius:2px';
    track.appendChild(bar);
    el.appendChild(logo);el.appendChild(msgEl);el.appendChild(track);
    document.body.appendChild(el);
    setTimeout(function(){var b=document.getElementById('loaderBar');if(b)b.style.width='85%';},50);
  }else{
    var m=document.getElementById('loaderMsg');
    if(m)m.textContent=msg||'Loading...';
  }
}
function hideLoader(){
  var el=document.getElementById('globalLoader');
  if(el){
    var b=document.getElementById('loaderBar');if(b)b.style.width='100%';
    setTimeout(function(){el.style.opacity='0';el.style.transition='opacity 0.4s';setTimeout(function(){if(el.parentNode)el.remove();},400);},300);
  }
}

// ─── Admin ───
function adminLogin(){
  const pw=document.getElementById('adminPwInput').value;
  if(pw===ADMIN_PASSWORD){
    document.getElementById('adminLoginWrap').style.display='none';
    document.getElementById('adminPanelWrap').style.display='block';
    _cloudCache=null;
    showLoader('Loading latest puzzles...');
    fetchCloudData().then(()=>{
      hideLoader();
      renderAdminLists();
      const today=getTodayStr();
      ['r4AdminDate','p3AdminDate','btlAdminDate','bingoAdminDate'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=today;});
    });
  }else{document.getElementById('adminErr').textContent='Incorrect password.';setTimeout(()=>document.getElementById('adminErr').textContent='',2000);}
}
function switchAdminTab(tab){
  document.querySelectorAll('.admin-tab').forEach((t,i)=>{const tabs=['rank4','perfect3','buildline','bingo'];t.classList.toggle('active',tabs[i]===tab);});
  document.querySelectorAll('.admin-tab-content').forEach(c=>c.classList.remove('active'));
  document.getElementById('admintab-'+tab).classList.add('active');
}
function showSaveMsg(id){const el=document.getElementById(id);el.classList.add('show');setTimeout(()=>el.classList.remove('show'),2500);}

async function saveR4Puzzle(){
  const date=document.getElementById('r4AdminDate').value;
  const itemsRaw=document.getElementById('r4AdminItems').value;
  const emojisRaw=document.getElementById('r4AdminEmojis').value;
  const pairRaw=document.getElementById('r4AdminPair').value;
  if(!date||!itemsRaw||!pairRaw){alert('Please fill in Date, Items, and Matching Pair');return;}
  const items=itemsRaw.split(',').map(s=>s.trim()).filter(Boolean);
  const emojiArr=emojisRaw.split(',').map(s=>s.trim());
  const emojis={};items.forEach((item,i)=>{emojis[item]=emojiArr[i]||'📦';});
  const pairNums=pairRaw.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n));
  const categories=[0,1,2,3].map(i=>{
    const name=document.getElementById(`r4c${i}name`).value.trim().toUpperCase();
    const desc=document.getElementById(`r4c${i}desc`).value.trim();
    const order=document.getElementById(`r4c${i}order`).value.split(',').map(s=>s.trim()).filter(Boolean);
    const factsRaw=document.getElementById(`r4c${i}facts`).value;
    const factArr=factsRaw.split(',').map(s=>s.trim());
    const facts={};order.forEach((item,j)=>{facts[item]=factArr[j]||'';});
    return{label:name,desc,order,facts};
  });
  const puzzle={date,items,emojis,categories,matchingPair:pairNums};
  const puzzles=[...getR4Puzzles()];
  const existIdx=puzzles.findIndex(p=>p.date===date);
  if(existIdx>-1)puzzles[existIdx]=puzzle;else puzzles.push(puzzle);
  puzzles.sort((a,b)=>a.date.localeCompare(b.date));
  showLoader('Saving puzzle...');
  await saveCloudData({r4_puzzles:puzzles});
  hideLoader();renderAdminLists();showSaveMsg('r4SaveMsg');r4State.initialized=false;
}

async function saveP3Puzzle(){
  const date=document.getElementById('p3AdminDate').value;
  const theme=document.getElementById('p3AdminTheme').value.trim();
  if(!date||!theme){alert('Please fill in Date and Theme');return;}
  const groups=[0,1,2].map(i=>({name:document.getElementById(`p3g${i}name`).value.trim(),items:document.getElementById(`p3g${i}items`).value.split(',').map(s=>s.trim()).filter(Boolean)}));
  const puzzle={date,theme,groups};
  const puzzles=[...getP3Puzzles()];
  const existIdx=puzzles.findIndex(p=>p.date===date);
  if(existIdx>-1)puzzles[existIdx]=puzzle;else puzzles.push(puzzle);
  showLoader('Saving puzzle...');
  await saveCloudData({p3_puzzles:puzzles});
  hideLoader();renderAdminLists();showSaveMsg('p3SaveMsg');p3State.initialized=false;
}

async function saveBtlPuzzle(){
  const date=document.getElementById('btlAdminDate').value;
  const category=document.getElementById('btlAdminCat').value.trim();
  if(!date||!category){alert('Please fill in Date and Category');return;}
  const labelSmall=document.getElementById('btlAdminLabelSmall').value.trim()||'Smallest';
  const labelLarge=document.getElementById('btlAdminLabelLarge').value.trim()||'Largest';
  const items=document.getElementById('btlAdminItems').value.split(',').map(s=>s.trim()).filter(Boolean);
  const emojis=document.getElementById('btlAdminEmojis').value.split(',').map(s=>s.trim());
  const values=document.getElementById('btlAdminValues').value.split(',').map(s=>s.trim());
  const puzzle={date,category,labelSmall,labelLarge,items,emojis,values};
  const puzzles=[...getBtlPuzzles()];
  const existIdx=puzzles.findIndex(p=>p.date===date);
  if(existIdx>-1)puzzles[existIdx]=puzzle;else puzzles.push(puzzle);
  showLoader('Saving puzzle...');
  await saveCloudData({btl_puzzles:puzzles});
  hideLoader();renderAdminLists();showSaveMsg('btlSaveMsg');btlState.initialized=false;
}

async function saveBingoPuzzle(){
  const date=document.getElementById('bingoAdminDate').value;
  const category=document.getElementById('bingoAdminCat').value.trim();
  if(!date||!category){alert('Please fill in Date and Category');return;}
  const grid=document.getElementById('bingoAdminGrid').value.split(',').map(s=>s.trim()).filter(Boolean);
  const promptLines=document.getElementById('bingoAdminPrompts').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const prompts=promptLines.map(line=>{
    const parts=line.split('|').map(s=>s.trim());
    const text=parts[0]||'';
    const matchStr=parts[1]||'';
    const matches=matchStr?matchStr.split(',').map(s=>parseInt(s.trim())).filter(n=>!isNaN(n)):[];
    return{text,matches};
  }).filter(p=>p.text);
  const puzzle={date,category,grid,prompts};
  const puzzles=[...getBingoPuzzles()];
  const existIdx=puzzles.findIndex(p=>p.date===date);
  if(existIdx>-1)puzzles[existIdx]=puzzle;else puzzles.push(puzzle);
  showLoader('Saving puzzle...');
  await saveCloudData({bingo_puzzles:puzzles});
  hideLoader();renderAdminLists();showSaveMsg('bingoSaveMsg');bingoState.initialized=false;
}

async function deleteAdminPuzzle(storageKey,date,listFn){
  if(!confirm(`Delete puzzle for ${date}?`))return;
  const keyMap={r4_puzzles:getR4Puzzles,p3_puzzles:getP3Puzzles,btl_puzzles:getBtlPuzzles,bingo_puzzles:getBingoPuzzles};
  const current=(keyMap[storageKey]?keyMap[storageKey]():[]).filter(p=>p.date!==date);
  showLoader('Deleting puzzle...');
  await saveCloudData({[storageKey]:current});
  hideLoader();listFn();
}

function renderAdminLists(){
  renderAdminList('r4AdminList',getR4Puzzles(),'r4_puzzles',p=>p.items.join(', '),renderAdminLists);
  renderAdminList('p3AdminList',getP3Puzzles(),'p3_puzzles',p=>p.theme,renderAdminLists);
  renderAdminList('btlAdminList',getBtlPuzzles(),'btl_puzzles',p=>p.category,renderAdminLists);
  renderAdminList('bingoAdminList',getBingoPuzzles(),'bingo_puzzles',p=>p.category,renderAdminLists);
}

function renderAdminList(elId,puzzles,storageKey,labelFn,refresh){
  const el=document.getElementById(elId);if(!el)return;
  if(!puzzles.length){el.innerHTML='<div style="font-size:0.75rem;color:var(--muted);padding:10px">No puzzles saved yet.</div>';return;}
  el.innerHTML=[...puzzles].reverse().map(p=>`
    <div class="admin-list-item">
      <div class="admin-list-item-info"><div class="admin-list-date">${p.date}</div><div class="admin-list-name">${labelFn(p)}</div></div>
      <button class="btn-admin-del" onclick="deleteAdminPuzzle('${storageKey}','${p.date}',renderAdminLists)">Delete</button>
    </div>`).join('');
}

// ─── Archive ───
function renderArchive(){
  const el=document.getElementById('archiveContent');
  const puzzles=getR4Puzzles();
  const today=getTodayStr();
  const sorted=[...puzzles].sort((a,b)=>b.date.localeCompare(a.date));
  el.innerHTML=`<div style="font-size:0.75rem;color:var(--muted);margin-bottom:16px">Play previous Rank 4 puzzles.</div>
    <div class="archive-grid">${sorted.map((p,i)=>{const isToday=p.date===today;
      return`<div class="archive-item" onclick="loadR4Archive('${p.date}')">
        <div class="archive-num">#${sorted.length-i}</div>
        <div class="archive-info"><div class="archive-date">${p.date}</div><div class="archive-items-preview">${p.items.join(' · ')}</div></div>
        <div class="archive-badge ${isToday?'today':''}">${isToday?'Today':'Play'}</div>
      </div>`;}).join('')}</div>`;
}

function loadR4Archive(date){
  const puzzle=getR4Puzzles().find(p=>p.date===date);if(!puzzle)return;
  r4State.initialized=false;r4ArchivePuzzle=puzzle;showPage('rank4');initR4(puzzle);r4ArchivePuzzle=null;
}
let r4ArchivePuzzle=null;

// ═══════════════════════════════════════════════════════
// RANK 4
// ═══════════════════════════════════════════════════════
const R4_CAT_COLORS=['var(--c0)','var(--c1)','var(--c2)','var(--c3)'];
const R4_MAX_CHECKS=3;
let r4Puzzle,r4State={initialized:false};

function initR4(overridePuzzle){
  const puzzles=getR4Puzzles();
  r4Puzzle=overridePuzzle||getPuzzleForToday(puzzles).puzzle;
  r4State={initialized:true,userOrder:r4Puzzle.categories.map(c=>shuffle([...c.order])),lockedItems:Array(4).fill(null).map(()=>new Set()),catCorrect:Array(4).fill(false),checksUsed:0,pairSel:[],pairLinked:false,gameOver:false};
  const emojis=r4Puzzle.emojis||{};
  document.getElementById('r4HeroCards').innerHTML=r4Puzzle.items.map(item=>`<div class="r4-hero-card"><span class="r4-card-emoji">${emojis[item]||'📦'}</span><span class="r4-card-name">${item}</span></div>`).join('');
  ['r4Hero','r4Progress','r4PairBox','r4CatsList'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='';});
  document.getElementById('r4Results').classList.remove('show');
  const now=new Date();const dl=now.toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'}).toUpperCase();
  document.getElementById('r4ResDate').textContent=dl;document.getElementById('r4ResDateFail').textContent=dl;
  r4UpdateProgress();r4RenderPairPills();r4RenderCats();
  setTimeout(()=>document.getElementById('r4HelpOverlay').classList.add('show'),400);
}

function shuffle(arr){const a=[...arr];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}if(a.join()===arr.join())[a[0],a[1]]=[a[1],a[0]];return a;}

function r4UpdateProgress(){
  document.getElementById('r4Pips').innerHTML=r4State.catCorrect.map((d,i)=>`<div class="pip${d?' lit-'+i:''}"></div>`).join('');
  const used=r4State.checksUsed;
  document.getElementById('r4CheckPips').innerHTML=Array.from({length:R4_MAX_CHECKS}).map((_,i)=>`<div class="${i<used?'check-pip used':'check-pip remaining'}"></div>`).join('');
  document.getElementById('r4PairPip').className='pair-pip'+(r4State.pairLinked?' lit':'');
}

function r4RenderPairPills(){
  const[pa,pb]=r4Puzzle.matchingPair;
  document.getElementById('r4PairPills').innerHTML=r4Puzzle.categories.map((cat,ci)=>{
    const isLinked=r4State.pairLinked&&(ci===pa||ci===pb);
    const isSel=r4State.pairSel.includes(ci);
    let cls=`pair-pill pp${ci}`;
    if(isLinked)cls+=' linked-done';else if(isSel)cls+=' sel';
    const dis=(r4State.pairLinked||r4State.gameOver)?'disabled':'';
    return`<button class="${cls}" onclick="r4TogglePill(${ci})" ${dis}>${cat.label}</button>`;
  }).join('');
  document.getElementById('r4BtnLink').disabled=r4State.pairSel.length!==2||r4State.pairLinked||r4State.gameOver;
}

function r4TogglePill(ci){
  if(r4State.pairLinked||r4State.gameOver)return;
  const idx=r4State.pairSel.indexOf(ci);
  if(idx>-1)r4State.pairSel.splice(idx,1);
  else if(r4State.pairSel.length<2)r4State.pairSel.push(ci);
  else r4State.pairSel=[r4State.pairSel[1],ci];
  r4SetPairMsg('Select two categories above','');
  document.getElementById('r4WrongReveal').classList.remove('show');
  r4RenderPairPills();
}

function r4LinkPair(){
  if(r4State.pairSel.length!==2||r4State.pairLinked||r4State.gameOver)return;
  const[a,b]=r4State.pairSel;const[pa,pb]=r4Puzzle.matchingPair;
  const correct=(a===pa&&b===pb)||(a===pb&&b===pa);
  if(correct){
    r4State.pairLinked=true;r4State.gameOver=true;
    r4Puzzle.categories.forEach((cat,ci)=>{if(!r4State.catCorrect[ci]&&r4State.userOrder[ci].join(',')===cat.order.join(','))r4State.catCorrect[ci]=true;});
    r4UpdateProgress();setTimeout(()=>r4ShowResults(true),600);
  }else{
    r4State.gameOver=true;r4ShowWrongReveal(a,b);r4SetPairMsg('Wrong pair — game over!','err');
    r4ShakePills([a,b]);r4State.pairSel=[];r4RenderPairPills();setTimeout(()=>r4ShowResults(false),1800);
  }
}

function r4ShowWrongReveal(a,b){
  const buildRow=(cat,userOrder,catIdx)=>{
    const tiles=userOrder.map((item,pos)=>{const wrong=cat.order.indexOf(item)!==pos;return`<span class="pwt${wrong?' wrong':''}">${item}</span>${pos<userOrder.length-1?'<span class="pwr-arrow">→</span>':''}`}).join('');
    return`<div class="pair-wrong-row"><div class="pair-wrong-label" style="color:${R4_CAT_COLORS[catIdx]}">${cat.label}</div><div class="pair-wrong-tiles">${tiles}</div></div>`;
  };
  document.getElementById('r4WrongRows').innerHTML=buildRow(r4Puzzle.categories[a],r4State.userOrder[a],a)+buildRow(r4Puzzle.categories[b],r4State.userOrder[b],b);
  const allDiffs=[...new Set([...r4State.userOrder[a].filter((item,i)=>r4Puzzle.categories[a].order.indexOf(item)!==i),...r4State.userOrder[b].filter((item,i)=>r4Puzzle.categories[b].order.indexOf(item)!==i)])];
  const hint=allDiffs.length?`Tip: ${allDiffs.slice(0,2).join(' and ')} need moving`:'';
  const hEl=document.getElementById('r4SwapHint');hEl.textContent=hint;hEl.style.display=hint?'':'none';
  document.getElementById('r4WrongReveal').classList.add('show');
}

function r4SetPairMsg(text,type){const el=document.getElementById('r4PairMsg');el.textContent=text;el.className='pair-msg'+(type?' '+type:'');}
function r4ShakePills(indices){const btns=document.getElementById('r4PairPills').querySelectorAll('.pair-pill');indices.forEach(ci=>{if(btns[ci]){btns[ci].style.animation='shake 0.35s ease';setTimeout(()=>{if(btns[ci])btns[ci].style.animation='';},400);}});}

function r4RenderCats(){
  const list=document.getElementById('r4CatsList');list.innerHTML='';
  r4Puzzle.categories.forEach((cat,ci)=>{
    const correct=r4State.catCorrect[ci];const locked=r4State.lockedItems[ci];
    const checksLeft=R4_MAX_CHECKS-r4State.checksUsed;
    const checkLabel=correct?'✓ Correct':checksLeft>0?`Check Order (${checksLeft} left)`:'No checks left';
    const block=document.createElement('div');
    block.className=`cat-block b${ci}${correct?' correct':''}`;block.id=`r4cat-${ci}`;
    block.innerHTML=`<div class="cat-topbar"></div>
      <div class="cat-header">
        <div class="cat-header-left"><div class="cat-swatch"></div><div><div class="cat-name">${cat.label}</div><div class="cat-desc">${cat.desc}</div></div></div>
        <div class="cat-header-right">
          <div class="star-slot${correct?' lit':''}">⭐</div>
          <button class="btn-check${!correct&&checksLeft===0?' no-checks':''}" id="r4checkbtn-${ci}"
            ${correct||r4State.gameOver||checksLeft===0?'disabled':''} onclick="r4CheckOrder(${ci})">${checkLabel}</button>
        </div>
      </div>
      <div class="rank-row" id="r4rankrow-${ci}">
        ${r4State.userOrder[ci].map((item,ri)=>{const isLocked=locked.has(item);const fact=(cat.facts&&cat.facts[item])||'';return`
          ${ri>0?'<div class="rank-arrow">→</div>':''}
          <div class="rank-entry">
            <div class="rank-num">${ri+1}${['st','nd','rd','th'][ri]}</div>
            <div class="${isLocked?'rank-tile locked':'rank-tile'}" data-ci="${ci}" data-ri="${ri}"${isLocked?' data-locked="1"':''}>${item}</div>
            <div class="item-fact${correct&&fact?' revealed':''}">${fact}</div>
          </div>`;}).join('')}
      </div>`;
    list.appendChild(block);
    if(!correct&&!r4State.gameOver)r4SetupInteraction(ci);
  });
}

function r4SetupInteraction(ci){
  const row=document.getElementById(`r4rankrow-${ci}`);if(!row)return;
  let ghost=null,fromRi=null,activeTouch=null,isDragging=false,startX,startY;
  const THRESH=8;
  function getTiles(){return Array.from(row.querySelectorAll('.rank-tile'));}
  function createGhost(text,x,y){ghost=document.createElement('div');ghost.className='drag-ghost';ghost.textContent=text;document.body.appendChild(ghost);moveGhost(x,y);}
  function moveGhost(x,y){if(!ghost)return;ghost.style.left=(x-ghost.offsetWidth/2)+'px';ghost.style.top=(y-ghost.offsetHeight/2)+'px';}
  function removeGhost(){if(ghost){ghost.remove();ghost=null;}}
  function getTileAt(x,y){return document.elementsFromPoint(x,y).find(el=>el.classList.contains('rank-tile')&&parseInt(el.dataset.ci)===ci)||null;}
  function highlight(t){getTiles().forEach(tt=>tt.classList.remove('drag-over'));if(t)t.classList.add('drag-over');}
  function doSwap(toRi){
    if(toRi===fromRi||toRi===null)return;
    const fi=r4State.userOrder[ci][fromRi],ti=r4State.userOrder[ci][toRi];
    if(r4State.lockedItems[ci].has(fi)||r4State.lockedItems[ci].has(ti))return;
    [r4State.userOrder[ci][fromRi],r4State.userOrder[ci][toRi]]=[ti,fi];r4RenderCats();r4RenderPairPills();
  }
  getTiles().forEach(tile=>{
    tile.addEventListener('mousedown',e=>{
      if(e.button!==0)return;fromRi=parseInt(tile.dataset.ri);startX=e.clientX;startY=e.clientY;isDragging=false;
      function onMove(e){const dx=e.clientX-startX,dy=e.clientY-startY;if(!isDragging&&Math.sqrt(dx*dx+dy*dy)>THRESH){isDragging=true;tile.classList.add('dragging');createGhost(tile.textContent.trim(),e.clientX,e.clientY);}if(isDragging){moveGhost(e.clientX,e.clientY);const t=getTileAt(e.clientX,e.clientY);highlight(t!==tile?t:null);}}
      function onUp(e){document.removeEventListener('mousemove',onMove);document.removeEventListener('mouseup',onUp);if(isDragging){tile.classList.remove('dragging');getTiles().forEach(t=>t.classList.remove('drag-over'));removeGhost();const t=getTileAt(e.clientX,e.clientY);if(t&&t!==tile)doSwap(parseInt(t.dataset.ri));}isDragging=false;fromRi=null;}
      document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp);
    });
    tile.addEventListener('touchstart',e=>{if(activeTouch!==null)return;activeTouch=e.touches[0].identifier;fromRi=parseInt(tile.dataset.ri);const t=e.touches[0];startX=t.clientX;startY=t.clientY;isDragging=false;},{passive:true});
    tile.addEventListener('touchmove',e=>{const touch=Array.from(e.touches).find(t=>t.identifier===activeTouch);if(!touch)return;const dx=touch.clientX-startX,dy=touch.clientY-startY;if(!isDragging&&Math.sqrt(dx*dx+dy*dy)>THRESH){isDragging=true;tile.classList.add('dragging');createGhost(tile.textContent.trim(),touch.clientX,touch.clientY);}if(isDragging){e.preventDefault();moveGhost(touch.clientX,touch.clientY);const t=getTileAt(touch.clientX,touch.clientY);highlight(t&&t!==tile?t:null);}},{passive:false});
    tile.addEventListener('touchend',e=>{const ct=Array.from(e.changedTouches).find(t=>t.identifier===activeTouch);if(!ct)return;activeTouch=null;if(isDragging){tile.classList.remove('dragging');getTiles().forEach(t=>t.classList.remove('drag-over'));removeGhost();const t=getTileAt(ct.clientX,ct.clientY);if(t&&t!==tile)doSwap(parseInt(t.dataset.ri));}isDragging=false;fromRi=null;},{passive:true});
    tile.addEventListener('touchcancel',()=>{activeTouch=null;isDragging=false;fromRi=null;tile.classList.remove('dragging');getTiles().forEach(t=>t.classList.remove('drag-over'));removeGhost();},{passive:true});
  });
}

function r4CheckOrder(ci){
  if(r4State.catCorrect[ci]||r4State.gameOver)return;
  if(r4State.checksUsed>=R4_MAX_CHECKS)return;
  r4State.checksUsed++;r4UpdateProgress();
  const correctOrder=r4Puzzle.categories[ci].order;const userOrder=r4State.userOrder[ci];let allCorrect=true;
  userOrder.forEach((item,ri)=>{if(correctOrder[ri]===item)r4State.lockedItems[ci].add(item);else allCorrect=false;});
  if(allCorrect){r4State.catCorrect[ci]=true;r4RenderCats();r4RenderPairPills();}
  else{
    const block=document.getElementById(`r4cat-${ci}`);const btn=document.getElementById(`r4checkbtn-${ci}`);
    block.classList.remove('wrong-flash');void block.offsetWidth;block.classList.add('wrong-flash');btn.classList.add('is-wrong');btn.textContent='✗ Some wrong';
    const rem=R4_MAX_CHECKS-r4State.checksUsed;
    r4ShowToast(rem>0?`${rem} check${rem===1?'':'s'} remaining`:'No more checks!');
    setTimeout(()=>{block.classList.remove('wrong-flash');btn.classList.remove('is-wrong');r4RenderCats();r4RenderPairPills();},700);
  }
}

function r4ShowToast(msg){const t=document.getElementById('r4Toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}

function r4ShowResults(won){
  r4State.gameOver=true;
  ['r4Hero','r4Progress','r4PairBox','r4CatsList'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
  const now=new Date();const dateStr=now.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'});
  const checksUsed=r4State.checksUsed;
  if(won){
    document.getElementById('r4FailContent').style.display='none';document.getElementById('r4WinContent').style.display='';
    document.getElementById('r4ResStripe').classList.remove('fail');
    const starsRow=document.getElementById('r4StarsRow');starsRow.innerHTML='';
    const STAR_COLORS=['var(--c0)','var(--c1)','var(--c2)','var(--c3)'];
    const EMPTY_STAR_COLORS=['rgba(232,57,30,0.2)','rgba(245,158,11,0.2)','rgba(14,165,114,0.2)','rgba(47,84,235,0.2)'];
    r4State.catCorrect.forEach((correct,i)=>{const s=document.createElement('span');s.className='r4-star';s.style.animationDelay=(i*0.09)+'s';s.innerHTML=correct?`<span style="color:${STAR_COLORS[i]};filter:drop-shadow(0 2px 6px ${STAR_COLORS[i]})">★</span>`:`<span style="color:${EMPTY_STAR_COLORS[i]}">★</span>`;starsRow.appendChild(s);});
    const stars=r4State.catCorrect.filter(Boolean).length;
    document.getElementById('r4ScoreSub').textContent=`${stars}/4 categories · ${checksUsed}/${R4_MAX_CHECKS} checks used`;
    const[pa,pb]=r4Puzzle.matchingPair;const pairLabel=`${r4Puzzle.categories[pa].label} & ${r4Puzzle.categories[pb].label}`;
    const shareText=`RANK 4 — ${dateStr}\n${'★'.repeat(stars)}${'☆'.repeat(4-stars)} ${stars}/4\nChecks: ${checksUsed}/${R4_MAX_CHECKS}\nPair: ✓ ${pairLabel}`;
    document.getElementById('r4ShareBox').textContent=shareText;
    document.getElementById('r4BtnCopy').onclick=()=>{navigator.clipboard.writeText(shareText).catch(()=>{});document.getElementById('r4BtnCopy').textContent='Copied! ✓';setTimeout(()=>document.getElementById('r4BtnCopy').textContent='Copy Result',1800);};
  }else{
    document.getElementById('r4WinContent').style.display='none';document.getElementById('r4FailContent').style.display='';document.getElementById('r4ResStripe').classList.add('fail');
    const[pa,pb]=r4Puzzle.matchingPair;
    document.getElementById('r4FailSub').innerHTML=`The matching pair was<br><strong style="color:rgba(255,255,255,0.85)">${r4Puzzle.categories[pa].label} & ${r4Puzzle.categories[pb].label}</strong><br>Come back tomorrow for a new puzzle!`;
    const shareText=`RANK 4 — ${dateStr}\n❌ Wrong pair\nChecks: ${checksUsed}/${R4_MAX_CHECKS}`;
    document.getElementById('r4ShareBoxFail').textContent=shareText;
    document.getElementById('r4BtnCopyFail').onclick=()=>{navigator.clipboard.writeText(shareText).catch(()=>{});document.getElementById('r4BtnCopyFail').textContent='Copied! ✓';setTimeout(()=>document.getElementById('r4BtnCopyFail').textContent='Copy Result',1800);};
  }
  const[pa,pb]=r4Puzzle.matchingPair;
  document.getElementById('r4AnswerRows').innerHTML=r4Puzzle.categories.map((cat,ci)=>{
    const isMatch=ci===pa||ci===pb;
    const pillsHTML=cat.order.map((item,i)=>{const fact=(cat.facts&&cat.facts[item])||'';
      return`${i>0?'<span class="ans-arrow">→</span>':''}
        <div class="r4-pill-wrap"><span class="r4-item-pill">${item}</span>${fact?`<span class="r4-item-fact">${fact}</span>`:''}</div>`;}).join('');
    return`<div class="r4-answer-row"><div class="r4-answer-cat" style="color:${R4_CAT_COLORS[ci]}">${cat.label}${isMatch?'<span class="match-flag">MATCH</span>':''}</div><div class="r4-answer-pills">${pillsHTML}</div></div>`;
  }).join('');
  document.getElementById('r4Results').classList.add('show');document.getElementById('r4Results').scrollIntoView({behavior:'smooth'});
}

document.getElementById('r4BtnLink').addEventListener('click',r4LinkPair);

// ═══════════════════════════════════════════════════════
// PERFECT 3s — 3 attempts max (CHANGED from 4)
// ═══════════════════════════════════════════════════════
const P3_MAX_ATTEMPTS = 3; // CHANGED
let p3Puzzle,p3State={initialized:false};

function initP3(){
  const puzzles=getP3Puzzles();
  p3Puzzle=getPuzzleForToday(puzzles).puzzle;
  const groupItems=p3Puzzle.groups.flatMap(g=>g.items);
  p3State={initialized:true,items:shuffle([...groupItems]),selected:[],solved:[],attemptsLeft:P3_MAX_ATTEMPTS,gameOver:false,message:'',messageType:''};
  renderP3();
  setTimeout(()=>document.getElementById('p3HelpOverlay').classList.add('show'),400);
}

function renderP3(){
  const wrap=document.getElementById('p3Wrap');
  const GRP_COLORS=['var(--p3-a)','var(--p3-b)','var(--p3-c)'];
  const GRP_NAMES=['sg0','sg1','sg2'];
  // CHANGED: dots based on P3_MAX_ATTEMPTS
  const dotsHTML=Array.from({length:P3_MAX_ATTEMPTS}).map((_,i)=>{const used=P3_MAX_ATTEMPTS-p3State.attemptsLeft;return`<div class="p3-dot${i<used?' used':''}"></div>`;}).join('');
  const solvedHTML=p3State.solved.map(gi=>{const g=p3Puzzle.groups[gi];return`<div class="p3-solved-group ${GRP_NAMES[gi]}"><div class="p3-solved-name" style="color:${GRP_COLORS[gi]}">${g.name}</div><div class="p3-solved-items-row">${g.items.map(item=>`<span class="p3-solved-pill">${item}</span>`).join('')}</div></div>`;}).join('');
  const gridHTML=p3State.items.map((item,idx)=>{
    const solvedGroupIdx=p3State.solved.findIndex(gi=>p3Puzzle.groups[gi].items.includes(item));
    const isSolved=solvedGroupIdx>-1;const isSel=p3State.selected.includes(item);
    let cls='p3-item';
    if(isSolved)cls+=` solved-tile ${GRP_NAMES[solvedGroupIdx]}`;else if(isSel)cls+=' sel';
    const dis=isSolved||p3State.gameOver?'disabled':'';
    return`<div class="${cls}" onclick="p3ToggleItem(${idx})" ${dis}>${item}</div>`;
  }).join('');
  let footer='';
  if(p3State.solved.length===3){footer=`<div class="p3-msg ok" style="padding:12px 0;font-size:0.9rem">All three groups found!</div>`;}
  else if(p3State.gameOver){
    const revealHTML=p3Puzzle.groups.map((g,gi)=>{if(p3State.solved.includes(gi))return'';return`<div class="p3-reveal-row"><div class="p3-reveal-label" style="color:${GRP_COLORS[gi]}">${g.name}</div>${g.items.map(item=>`<span class="p3-reveal-pill">${item}</span>`).join('')}</div>`;}).join('');
    footer=`<div class="p3-msg err" style="margin-bottom:10px">No attempts left — game over!</div><div class="p3-gameover-reveal"><div class="p3-gameover-label">The correct groups were:</div>${revealHTML}</div>`;
  }else{
    const count=p3State.selected.length;
    const msg=count===0?'Select 3 items that belong together':count<3?`${3-count} more to select`:'Ready — submit!';
    footer=`<div class="p3-actions"><button class="btn-p3-submit" onclick="p3Submit()" ${count!==3?'disabled':''}>Submit Group</button><span class="p3-msg${p3State.messageType?' '+p3State.messageType:''}">${p3State.message||msg}</span></div>`;
  }
  wrap.innerHTML=`
    <div class="p3-header">
      <div class="p3-title">Perfect 3s</div>
      <div class="p3-sub">${p3Puzzle.theme} — Find three groups of three</div>
      <div class="p3-header-bottom"><span class="p3-attempts-label">Attempts left</span><div class="p3-attempts">${dotsHTML}</div></div>
    </div>
    ${solvedHTML}
    <div class="p3-grid">${gridHTML}</div>
    ${footer}`;
}

function p3ToggleItem(idx){
  if(p3State.gameOver)return;const item=p3State.items[idx];const selIdx=p3State.selected.indexOf(item);
  p3State.message='';p3State.messageType='';
  if(selIdx>-1)p3State.selected.splice(selIdx,1);else if(p3State.selected.length<3)p3State.selected.push(item);
  renderP3();
}

function p3Submit(){
  const sel=p3State.selected;if(sel.length!==3||p3State.gameOver)return;
  const matchGroup=p3Puzzle.groups.findIndex((g,gi)=>!p3State.solved.includes(gi)&&sel.every(item=>g.items.includes(item)));
  if(matchGroup>-1){
    p3State.solved.push(matchGroup);p3State.selected=[];
    p3State.message=p3State.solved.length===3?'All three groups found!':'Correct!';p3State.messageType='ok';
    if(p3State.solved.length===3)p3State.gameOver=true;renderP3();
  }else{
    p3State.attemptsLeft--;p3State.message=p3State.attemptsLeft>0?`Not a group — ${p3State.attemptsLeft} left`:'';p3State.messageType='err';
    if(p3State.attemptsLeft<=0){p3State.gameOver=true;p3State.selected=[];renderP3();return;}
    const grid=document.getElementById('p3Wrap')?.querySelector('.p3-grid');
    if(grid)[...grid.children].forEach((cell,i)=>{if(sel.includes(p3State.items[i])){cell.classList.add('wrong-flash');setTimeout(()=>cell.classList.remove('wrong-flash'),400);}});
    p3State.selected=[];setTimeout(renderP3,460);
  }
}

// ═══════════════════════════════════════════════════════
// BUILD THE LINE — distance-based scoring, out of 21
// ═══════════════════════════════════════════════════════
let btlPuzzle,btlState={initialized:false};

// CHANGED: BTL_MAX_SCORE uses 3 pts per item (7 items → 7-1=6 placeable, but scoring starts from item 2)
// Total items to place = N-1 (first is placed automatically), each worth up to 3 pts
// Max = (N-1)*3. With 7 items: 6*3=18. But spec says "out of 21" = 7*3
// We score all 7 including first (distance=0 always), so max = 7*3 = 21
// Let's score item 0 as placed correctly (auto), items 1..N-1 scored by distance
const BTL_PTS_FOR_DISTANCE = [3, 2, 1, 0]; // index = distance (3+ → 0)

function btlPointsForDistance(distance) {
  return distance < BTL_PTS_FOR_DISTANCE.length ? BTL_PTS_FOR_DISTANCE[distance] : 0;
}

function initBtl(){
  const puzzles=getBtlPuzzles();btlPuzzle=getPuzzleForToday(puzzles).puzzle;
  const ri=btlPuzzle.items.map((_,i)=>i);
  for(let i=ri.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[ri[i],ri[j]]=[ri[j],ri[i]];}
  // First item is auto-placed, award it 3 pts (correct by definition)
  const n = btlPuzzle.items.length;
  const maxScore = n * 3; // e.g. 7*3=21
  btlState={initialized:true,revealOrder:ri,lineSlots:[ri[0]],currentItemIdx:1,score:3,ptsBySlot:[3],done:false,maxScore};
  renderBtl();
  setTimeout(()=>document.getElementById('btlHelpOverlay').classList.add('show'),400);
}

function renderBtl(){
  const wrap=document.getElementById('btlWrap');
  const total=btlPuzzle.items.length;const done=btlState.done;
  const pct=Math.round((btlState.score/btlState.maxScore)*100);
  const dots=Array.from({length:total}).map((_,i)=>{let cls='btl-prog-dot';if(i<btlState.lineSlots.length)cls+=' placed';else if(i===btlState.lineSlots.length)cls+=' current';return`<div class="${cls}"></div>`;}).join('');
  const curIdx=!done&&btlState.currentItemIdx<total?btlState.revealOrder[btlState.currentItemIdx]:null;
  const labelSmall=btlPuzzle.labelSmall||'Smallest';
  const labelLarge=btlPuzzle.labelLarge||'Largest';
  const curItemHTML=curIdx!==null?`<div class="btl-item-card"><div class="btl-item-emoji">${btlPuzzle.emojis[curIdx]||'📦'}</div><div class="btl-item-info"><div class="btl-item-eyebrow">Where does this go on the line?</div><div class="btl-item-name">${btlPuzzle.items[curIdx]}</div><div class="btl-item-progress">${dots}</div></div></div>`:'';
  const slots=btlState.lineSlots;
  let spineHTML='<div class="btl-spine">';
  slots.forEach((corrIdx,pos)=>{
    if(!done)spineHTML+=`<div class="btl-insert-zone" onclick="btlInsertAt(${pos})"><div class="btl-insert-inner"><span class="plus">+</span>Insert here</div></div>`;
    // Determine correctness for display
    let dotCls='btl-node-dot',cardCls='btl-placed-card';
    let ptsLabel='';
    if(done){
      // sort slots to get correct order, find where corrIdx should be
      const sortedSlots=[...slots].sort((a,b)=>a-b);
      const correctPos=sortedSlots.indexOf(corrIdx);
      const distance=Math.abs(pos-correctPos);
      const pts=btlPointsForDistance(distance);
      if(distance===0){dotCls+=' correct';cardCls+=' correct';ptsLabel='+3';}
      else if(distance===1){dotCls+=' wrong';cardCls+=' partial';ptsLabel='+2';}
      else if(distance===2){dotCls+=' wrong';cardCls+=' partial';ptsLabel='+1';}
      else{dotCls+=' wrong';cardCls+=' wrong';ptsLabel='+0';}
    }
    spineHTML+=`<div class="btl-placed-node"><div class="${dotCls}"></div><div class="${cardCls}"><span class="btl-placed-emoji-sm">${btlPuzzle.emojis[corrIdx]||'📦'}</span><span class="btl-placed-text">${btlPuzzle.items[corrIdx]}</span>${done&&btlPuzzle.values[corrIdx]?`<span class="btl-placed-value">${btlPuzzle.values[corrIdx]}</span>`:''}${done?`<span class="btl-placed-pts">${ptsLabel}</span>`:''}</div></div>`;
  });
  if(!done)spineHTML+=`<div class="btl-insert-zone" onclick="btlInsertAt(${slots.length})"><div class="btl-insert-inner"><span class="plus">+</span>Insert here</div></div>`;
  spineHTML+='</div>';

  const maxScore=btlState.maxScore;
  const resultHTML=done?`<div class="btl-result-card">
    <div class="btl-result-heading">${pct===100?'"A flawless line — perfect score!"':pct>=75?'"Great reading — strong result!"':pct>=50?'"Solid effort!"':'"A tricky one — keep practising!"'}</div>
    <div class="btl-result-pts">${btlState.score}</div>
    <div class="btl-result-pts-lbl">out of ${maxScore} points</div>
    <div class="btl-result-bar"><div class="btl-result-bar-fill" id="btlFill"></div></div>
    <div class="btl-result-pct">${pct}% · ${btlState.score}/${maxScore} · Scoring: exact=3pts, 1 off=2pts, 2 off=1pt, 3+ off=0pts</div>
  </div>`:'';

  wrap.innerHTML=`<div class="btl-header"><div class="btl-header-left"><div class="btl-title">Build the Line</div><div class="btl-cat-label">${btlPuzzle.category}</div></div><div class="btl-header-right"><div class="btl-score-big">${btlState.score}/${maxScore}</div><div class="btl-score-lbl">${done?'Final Score':'Score'}</div></div></div>${curItemHTML}${resultHTML}<div class="btl-line-wrap"><div class="btl-line-header"><span class="btl-line-end-label">↑ ${labelSmall}</span><span class="btl-line-end-label">${labelLarge} ↓</span></div>${spineHTML}</div>`;
  if(done)setTimeout(()=>{const b=document.getElementById('btlFill');if(b)b.style.width=pct+'%';},100);
}

function btlInsertAt(pos){
  if(btlState.done||btlState.currentItemIdx>=btlPuzzle.items.length)return;
  const correctIdx=btlState.revealOrder[btlState.currentItemIdx];
  btlState.lineSlots.splice(pos,0,correctIdx);
  // Compute distance-based score for this placement
  // Correct position = number of items in lineSlots with index < correctIdx (after insertion)
  const sortedSlots=[...btlState.lineSlots].sort((a,b)=>a-b);
  const correctPos=sortedSlots.indexOf(correctIdx);
  const distance=Math.abs(pos-correctPos);
  const pts=btlPointsForDistance(distance);
  btlState.score+=pts;
  btlState.currentItemIdx++;
  if(btlState.currentItemIdx>=btlPuzzle.items.length)btlState.done=true;
  renderBtl();
}

// ═══════════════════════════════════════════════════════
// TRIVIA BINGO — redesigned UI
// ═══════════════════════════════════════════════════════
let bingoState={initialized:false};
let bingoPuzzle;

function initBingo(){
  const puzzles=getBingoPuzzles();bingoPuzzle=getPuzzleForToday(puzzles).puzzle;
  const prompts=shuffle([...bingoPuzzle.prompts]);
  bingoState={initialized:true,prompts,qIdx:0,marked:new Set(),selected:null,promptsLost:0,feedback:null,feedbackTimer:null,done:false,won:false,justBingo:false,completedLineKeys:new Set()};
  renderBingo();
  setTimeout(()=>document.getElementById('bingoHelpOverlay').classList.add('show'),400);
}

function checkBingoLines(marked){
  const lines=[];
  for(let r=0;r<4;r++)lines.push({key:`row${r}`,cells:[r*4,r*4+1,r*4+2,r*4+3]});
  for(let c=0;c<4;c++)lines.push({key:`col${c}`,cells:[c,c+4,c+8,c+12]});
  lines.push({key:'diag0',cells:[0,5,10,15]});lines.push({key:'diag1',cells:[3,6,9,12]});
  return lines.filter(l=>l.cells.every(i=>marked.has(i)));
}

function renderBingo(){
  const wrap=document.getElementById('bingoWrap');
  const state=bingoState;
  const prompt=state.prompts[state.qIdx];
  const promptsLeft=Math.max(0,state.prompts.length-state.qIdx);
  const markedCount=state.marked.size;
  const completedLines=checkBingoLines(state.marked);
  const lineCells=new Set(completedLines.flatMap(l=>l.cells));
  const lineCount=completedLines.length;

  // Progress ring
  const pct=Math.round((markedCount/16)*100);
  const circumference=188.5;
  const offset=circumference-(circumference*pct/100);

  const gridHTML=bingoPuzzle.grid.map((cell,i)=>{
    let cls='bingo-cell';
    const isMarked=state.marked.has(i);
    const isLine=lineCells.has(i);
    if(isMarked){cls+=isLine?' bingo-line':' marked';}
    else if(prompt&&!state.done&&!state.feedback){cls+=' selectable';if(state.selected===i)cls+=' selected';}
    const onclick=(!isMarked&&!state.done&&!state.feedback)?`onclick="bingoSelectCell(${i})"` :'';
    const checkMark=isMarked?'<span class="bingo-cell-check">✓</span>':'';
    return`<div class="${cls}" ${onclick}><span class="bingo-cell-num">${i+1}</span>${checkMark}${cell}</div>`;
  }).join('');

  // Build line pips (max 10 lines total: 4 rows + 4 cols + 2 diags)
  const totalLines=10;
  const linePipsHTML=`<div class="bingo-lines-bar"><span class="bingo-lines-label">Lines</span>${Array.from({length:totalLines}).map((_,i)=>`<div class="bingo-line-pip${i<lineCount?' lit':''}"></div>`).join('')}<span class="bingo-lines-count">${lineCount}</span></div>`;

  const feedbackHTML=state.feedback?`<div class="bingo-feedback-msg show ${state.feedback.type}">${state.feedback.msg}</div>`:'';
  const winBannerHTML=state.justBingo&&!state.feedback?`<div class="bingo-win-banner"><div class="bingo-win-banner-title">BINGO</div><div class="bingo-win-banner-sub">Line complete!</div></div>`:'';

  let promptHTML='';
  if(state.done){
    promptHTML=`<div class="bingo-complete-wrap"><div class="bingo-complete-title">${state.won?'Board complete!':'Out of prompts!'}</div><div class="bingo-complete-sub">${markedCount}/16 squares filled · ${lineCount} line${lineCount!==1?'s':''} completed · ${state.promptsLost} wrong answer${state.promptsLost!==1?'s':''}</div><button class="btn-bingo-skip" onclick="initBingo()" style="border-color:rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);margin-top:4px">Play Again</button></div>`;
  }else if(prompt){
    const isSel=state.selected!==null;
    const hintText=isSel?`"${bingoPuzzle.grid[state.selected]}" selected — confirm or tap another square`:'Tap a square on the grid, then confirm your answer';
    promptHTML=`<div class="bingo-prompt-area">
      <div class="bingo-prompt-head">
        <span class="bingo-prompt-head-label">Current prompt</span>
        <span class="bingo-prompt-counter">${state.qIdx+1} / ${state.prompts.length}</span>
      </div>
      <div class="bingo-prompt-body">
        <div class="bingo-prompt-text">${prompt.text}</div>
        <div class="bingo-prompt-hint${isSel?' active':''}">${hintText}</div>
        <div class="bingo-prompt-actions">
          <button class="btn-bingo-confirm" onclick="bingoConfirm()" ${!isSel?'disabled':''}>Confirm answer</button>
          <button class="btn-bingo-skip" onclick="bingoSkip()">Skip — no match</button>
        </div>
      </div>
    </div>`;
  }

  wrap.innerHTML=`
    <div class="bingo-masthead">
      <div class="bingo-masthead-inner">
        <div class="bingo-masthead-left">
          <div class="bingo-game-label">Today's Puzzle</div>
          <div class="bingo-title">Trivia Bingo</div>
          <div class="bingo-category">${bingoPuzzle.category}</div>
          <div class="bingo-counters">
            <div class="bingo-counter"><div class="bingo-counter-num">${markedCount}/16</div><div class="bingo-counter-lbl">Filled</div></div>
            <div class="bingo-counter"><div class="bingo-counter-num">${promptsLeft}</div><div class="bingo-counter-lbl">Prompts</div></div>
            <div class="bingo-counter"><div class="bingo-counter-num">${state.promptsLost}</div><div class="bingo-counter-lbl">Wrong</div></div>
          </div>
        </div>
        <div class="bingo-masthead-right">
          <div class="bingo-progress-ring-wrap">
            <svg width="72" height="72" viewBox="0 0 72 72">
              <circle class="bingo-progress-ring-bg" cx="36" cy="36" r="30"/>
              <circle class="bingo-progress-ring-fill" cx="36" cy="36" r="30" style="stroke-dashoffset:${offset}"/>
            </svg>
            <div class="bingo-progress-ring-text">
              <span class="bingo-progress-ring-pct">${pct}%</span>
              <span class="bingo-progress-ring-sub">filled</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    ${linePipsHTML}
    ${winBannerHTML}
    ${feedbackHTML}
    <div class="bingo-grid">${gridHTML}</div>
    ${promptHTML}`;
}

function bingoSelectCell(idx){
  if(bingoState.done||bingoState.feedback)return;
  if(bingoState.marked.has(idx))return;
  bingoState.selected=bingoState.selected===idx?null:idx;
  bingoState.justBingo=false;renderBingo();
}

function bingoConfirm(){
  if(bingoState.done||bingoState.selected===null||bingoState.feedback)return;
  const prompt=bingoState.prompts[bingoState.qIdx];
  const sel=bingoState.selected;
  const matches=prompt.matches||[];
  const isCorrect=matches.length>0&&matches.includes(sel);

  if(isCorrect){
    const prevKeys=new Set(checkBingoLines(bingoState.marked).map(l=>l.key));
    bingoState.marked.add(sel);
    const newLines=checkBingoLines(bingoState.marked).filter(l=>!prevKeys.has(l.key));
    bingoState.justBingo=newLines.length>0;
    bingoState.feedback={type:'correct',msg:bingoState.justBingo?`Correct — line completed!`:`Correct! "${bingoPuzzle.grid[sel]}" marked.`};
    if(bingoState.marked.size>=16){bingoState.won=true;bingoState.done=true;}
  }else{
    bingoState.promptsLost++;bingoState.justBingo=false;
    bingoState.feedback={type:'wrong',msg:`Wrong — "${bingoPuzzle.grid[sel]}" does not match this prompt.`};
  }
  bingoState.selected=null;renderBingo();
  if(bingoState.feedbackTimer)clearTimeout(bingoState.feedbackTimer);
  bingoState.feedbackTimer=setTimeout(()=>{
    bingoState.feedback=null;bingoState.justBingo=false;
    if(!bingoState.done){
      bingoState.qIdx++;
      if(bingoState.qIdx>=bingoState.prompts.length){if(bingoState.marked.size<16)bingoState.done=true;}
    }
    renderBingo();
  },1600);
}

function bingoSkip(){
  if(bingoState.done||bingoState.feedback)return;
  bingoState.selected=null;bingoState.justBingo=false;
  bingoState.qIdx++;
  if(bingoState.qIdx>=bingoState.prompts.length){if(bingoState.marked.size<16)bingoState.done=true;}
  renderBingo();
}

// ─── Boot ───
function renderHomeCards(){
  const r4=getPuzzleForToday(getR4Puzzles()).puzzle;
  const p3=getPuzzleForToday(getP3Puzzles()).puzzle;
  const btl=getPuzzleForToday(getBtlPuzzles()).puzzle;
  const bingo=getPuzzleForToday(getBingoPuzzles()).puzzle;
  document.getElementById('homeTodayCards').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px">
      ${[
        {name:'Rank 4',color:'var(--c0)',emoji:'🏆',sub:r4.items.slice(0,2).join(', ')+'…',page:'rank4'},
        {name:'Perfect 3s',color:'var(--p3-a)',emoji:'🎯',sub:p3.theme||'Group the items',page:'perfect3'},
        {name:'Build the Line',color:'var(--btl)',emoji:'📏',sub:btl.category,page:'buildline'},
        {name:'Trivia Bingo',color:'var(--bingo)',emoji:'🎱',sub:bingo.category,page:'bingo'},
      ].map(g=>`<div onclick="showPage('${g.page}')" style="background:var(--white);border:1.5px solid var(--edge);border-radius:14px;padding:16px;cursor:pointer;transition:all 0.15s" onmouseover="this.style.borderColor='${g.color}'" onmouseout="this.style.borderColor='var(--edge)'">
        <div style="font-size:1.6rem;margin-bottom:8px">${g.emoji}</div>
        <div style="font-size:1rem;font-weight:800;letter-spacing:2px;color:${g.color};margin-bottom:3px">${g.name}</div>
        <div style="font-size:0.7rem;font-weight:500;color:var(--muted)">${g.sub}</div>
      </div>`).join('')}
    </div>`;
}

showLoader('Loading puzzles...');
fetchCloudData().then(()=>{
  hideLoader();
  renderHomeCards();
  document.getElementById('page-home').classList.add('active');
});
</script>
</body>
</html>
